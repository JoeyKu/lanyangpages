# .github/workflows/fetch-data.yml

name: 'å®šæœŸæŠ“å–è³‡æ–™ä¸¦å­˜ç‚º JS'

on:
  # å…è¨±ä½ å¾ GitHub ç¶²ç«™çš„ "Actions" é é¢æ‰‹å‹•è§¸ç™¼æ­¤æµç¨‹ï¼ˆæ–¹ä¾¿æ¸¬è©¦ï¼‰
  workflow_dispatch:

  # è¨­å®šæ’ç¨‹è§¸ç™¼
  schedule:
    # ä½¿ç”¨ CRON èªæ³•ï¼Œ'0 0 * * *' ä»£è¡¨åœ¨æ¯å¤©çš„ UTC æ™‚é–“ 0 é»åŸ·è¡Œ
    # æ›ç®—æˆå°ç£/é¦™æ¸¯æ™‚é–“ (UTC+8) å°±æ˜¯æ¯å¤©æ—©ä¸Š 8 é»
    - cron: '0 0 * * *'

jobs:
  permissions:
    contents: write
  fetch-and-save:
    # æŒ‡å®šåŸ·è¡Œçš„è™›æ“¬ç’°å¢ƒ
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: å°‡ä½ çš„å€‰åº«ç¨‹å¼ç¢¼ checkout åˆ°è™›æ“¬ç’°å¢ƒä¸­
      # é€™æ˜¯ç‚ºäº†å¾ŒçºŒèƒ½å°‡è®Šå‹•çš„æª”æ¡ˆæäº¤å›å€‰åº«
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: æŠ“å–è³‡æ–™ä¸¦æ ¼å¼åŒ–æˆ JS æª”æ¡ˆ
      # é€™æ˜¯æ•´å€‹å·¥ä½œçš„æ ¸å¿ƒæ­¥é©Ÿ
      - name: Fetch data and create JS file
        # ä½¿ç”¨ run ä¾†åŸ·è¡Œ shell æŒ‡ä»¤
        run: |
          # å»ºç«‹ä¸€å€‹åç‚º data.js çš„æª”æ¡ˆï¼Œä¸¦å¯«å…¥ç¬¬ä¸€è¡Œ "var frontDestData = "
          echo "var frontDestData = " > data.js
          
          # ä½¿ç”¨ curl æŠ“å–ä½ çš„ URLï¼Œä¸¦å°‡å›å‚³çš„ JSON å…§å®¹é™„åŠ (>>)åˆ° data.js æª”æ¡ˆä¸­
          # è«‹å°‡ 'http://xxx.xxx.xxx/api/data' æ›æˆä½ å¯¦éš›çš„ç¶²å€
          # -sLï¼š-s ä»£è¡¨éœé»˜æ¨¡å¼(ä¸é¡¯ç¤ºé€²åº¦æ¢)ï¼Œ-L ä»£è¡¨è·Ÿéš¨è½‰å€
          curl -sL 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiAgnURLEkQGoZGMzWMNHdJl-GpyHQskF6A4PrM5D098Wa6hWhQ6gNJ-Nunou9Sr1YLMmV7IaDOoWvgVv18PcnJuYMXxY2a0lucBdUGc4xckUtQ-Pa6YJgv2CR4oK_zA6FNp6vezAVHC9WQ2a6NKSNirlSaPo0b_3B70DH1XBlXY-MkccH-RiZpt7RXz9XkfDoIXPqLksF80IcTLReciWhbpVcXNQkoADIrLRNMZaEQqJeSYuzOGQ1457p4c6UNkdcprcTDabnNFVYn1eDGwK-NTO_jsw&lib=MAV-k4GihlBHTvmdM35hRpd55ueH--ymm' >> data.js
          
          # åœ¨æª”æ¡ˆçµå°¾é™„åŠ ä¸€å€‹åˆ†è™Ÿï¼Œå®Œæˆ JavaScript èªæ³•
          echo ";" >> data.js
          
          echo "data.js æª”æ¡ˆå·²æˆåŠŸå»ºç«‹ã€‚"

      # æ­¥é©Ÿ 3: æäº¤ä¸¦æ¨é€è®Šå‹•åˆ°å€‰åº«
      # é€™æ®µç¨‹å¼ç¢¼æœƒæª¢æŸ¥ data.js æ˜¯å¦æœ‰è®Šå‹•ï¼Œå¦‚æœæœ‰ï¼Œå°±è‡ªå‹• commit & push
      - name: Commit and push if changed
        run: |
          # è¨­å®š Git çš„ä½¿ç”¨è€…åç¨±å’Œ Email
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@github.com"
          
          # å°‡ data.js åŠ å…¥ Git æš«å­˜å€
          git add data.js
          
          # æª¢æŸ¥æ˜¯å¦æœ‰æª”æ¡ˆè®Šå‹•
          # --quiet æœƒè®“æŒ‡ä»¤åœ¨æ²’æœ‰è®Šå‹•æ™‚å›å‚³æˆåŠŸ(exit code 0)ï¼Œæœ‰è®Šå‹•æ™‚å›å‚³å¤±æ•—(exit code 1)
          # 'git diff --staged --quiet' çš„æ„æ€æ˜¯ã€Œå¦‚æœæš«å­˜å€æ˜¯ç©ºçš„ï¼Œå°±ä»€éº¼éƒ½ä¸åšã€
          if git diff --staged --quiet; then
            echo "è³‡æ–™æ²’æœ‰è®Šå‹•ï¼Œç„¡éœ€æäº¤ã€‚"
          else
            # å¦‚æœæœ‰è®Šå‹•ï¼Œå‰‡å»ºç«‹ä¸€å€‹æäº¤è¨Šæ¯ä¸¦æ¨é€åˆ° main åˆ†æ”¯
            git commit -m "ğŸ“Š è‡ªå‹•æ›´æ–°å¤–éƒ¨è³‡æ–™ - $(date -u)"
            git push
          fi
