<!DOCTYPE html>
<html lang="zh-Hant">
   <head>
      <meta charset="UTF-8" />
      <title>三聯單及佛光卡填單說明</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.tailwindcss.com"></script>
   </head>
   <body class="bg-gray-100 font-sans text-base sm:text-lg md:text-xl leading-relaxed">
      <!-- 登入頁 -->
      <div id="loginPage" class="min-h-screen flex items-center justify-center px-6 py-8 sm:px-4 sm:py-6 hidden">
         <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-4xl">
            <h2 class="text-lg md:text-4xl lg:text-xl font-bold mb-6 text-center text-indigo-700">請輸入密碼</h2>
            <input type="password" id="passwordInput" class="w-full p-4 border rounded mb-4 text-lg md:text-4xl lg:text-xl" placeholder="輸入密碼">
            <button onclick="submitPassword()" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 text-lg md:text-4xl lg:text-xl">登入</button>
            <p id="error" class="text-red-600 text-[22px] mt-3 text-center"></p>
         </div>
      </div>
      <!-- 主畫面容器 -->
      <div id="app" class="min-h-screen px-6 py-8 sm:px-4 sm:py-6 hidden"></div>
      <script>
         const MAX_LOGIN_DURATION = 7 * 24 * 60 * 60 * 1000;
         
         let lastUpdate = null;
         
         function checkSessionValid() {
           const isLoggedIn = localStorage.getItem("isLoggedIn") === "yes";
           const loginTime = parseInt(localStorage.getItem("loginTime") || "0");
           const now = Date.now();
         
           if (isLoggedIn && now - loginTime < MAX_LOGIN_DURATION) {
             return true;
           } else {
             return false;
           }
         }
         
         window.addEventListener("DOMContentLoaded", () => {
           const isLoggedIn = localStorage.getItem("isLoggedIn") === "yes";
           const loginTime = parseInt(localStorage.getItem("loginTime") || "0");
           const now = Date.now();

           if (isLoggedIn && now - loginTime < MAX_LOGIN_DURATION) {
             loadMainApp();
           } else {
             document.getElementById("loginPage").classList.remove("hidden");
           }
         
         });
         
         // -------------------- 修改開始 (1/2) --------------------
         async function submitPassword() {
         
           const pw = document.getElementById("passwordInput").value.trim();
           const errorDiv = document.getElementById("error");
           const loginUrl = "https://36abxtve73lsev23b5bs3264iq0ksxal.lambda-url.us-east-1.on.aws/login";

           try {
               const response = await fetch(loginUrl, {
                   method: 'POST',
                   headers: {
                       'Content-Type': 'application/json',
                   },
                   body: JSON.stringify({ pass: pw }),
               });

               const result = await response.json();

               if (response.ok && result.token) {
		       // 登入成功
		   console.log("login OK")
                   localStorage.setItem("isLoggedIn", "yes");
                   localStorage.setItem("loginTime", Date.now().toString());
                   localStorage.setItem("token", result.token); // 儲存 token
                   loadMainApp();
               }
           } catch (error) {
               console.error('Login request failed:', error);
               errorDiv.textContent = "登入請求失敗，請檢查網路連線或稍後再試。";
           }
         }
         // -------------------- 修改結束 (1/2) --------------------

         function loadMainApp() {
           document.getElementById("loginPage").classList.add("hidden");
           document.getElementById("app").classList.remove("hidden");
         
           // -------------------- 修改開始 (2/2) --------------------
           async function updateApp() {
             if (!checkSessionValid()) {
		 document.getElementById("loginPage").classList.remove("hidden");
                 document.getElementById("app").classList.add("hidden");
                 document.getElementById("passwordInput").value = '';
                 return;
             }
             
             /*const apiKey = localStorage.getItem("apiKey");
             if (!apiKey) {
                 console.error("API Key not found, logging out.");
                 logout();
                 return;
             }*/

             const getInfoUrl = "https://36abxtve73lsev23b5bs3264iq0ksxal.lambda-url.us-east-1.on.aws/getinfo";

             try {
                const token = localStorage.getItem("token");
		if (!token) {
		    throw new Error(`API returned status ${response.status}`);
		}
		alert("bearer " + token)
                const response = await fetch(getInfoUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
			'Access-Control-Allow-Origin': '*',
			'Authorization': 'Bearer ' + token
                    }
                });

                 alert(response)
                if (!response.ok) {
                    // 如果 API Key 失效或後端出錯
                    throw new Error(`API returned status ${response.status}`);
                }

                const data = await response.json();
                const { events, annualEvents, faqs } = data;
                const app = document.getElementById("app");
          
                app.innerHTML = `
                  <div class="max-w-4xl mx-auto">
                    <h1 class="text-3xl sm:text-4xl md:text-6xl lg:text-3xl font-bold text-center text-indigo-700">三聯單及佛光卡填單說明</h1>
                    <br>
          
                    <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700 mb-6 text-center">近期活動</h2>
                    <div id="eventBlocks" class="space-y-4 mb-6">
                      ${renderEventBlocks(events, 'e')}
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-2 sm:gap-4 mb-6 text-center">
                      <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700">例行活動</h2>
                      <button onclick="toggleSection('annualEventsBlocks', 'toggleAnnualBtn')" id="toggleAnnualBtn" class="text-indigo-700 underline text-lg md:text-5xl lg:text-xl">
                        展開 ▼
                      </button>
                    </div>
          
                    <div id="annualEventsBlocks" class="space-y-4 mb-6 hidden">
                      ${renderEventBlocks(annualEvents, 'l')}
                    </div>
          
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-2 sm:gap-4 mb-6 text-center">
                      <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700">常見問答</h2>
                      <button onclick="toggleSection('faqSection', 'toggleFaqBtn')" id="toggleFaqBtn" class="text-indigo-700 underline text-lg md:text-5xl lg:text-xl">
                        展開 ▼
                      </button>
                    </div>
                    
                    <div id="faqSection" class="space-y-4 mb-6 hidden">
                      ${renderFaqs(faqs)}
                    </div>
                  </div>
                `;
             } catch (error) {
                console.error('Failed to fetch app data:', error);
                // 可以在這裡顯示一個錯誤訊息給使用者，或直接登出
                logout();
             }
           }
           // -------------------- 修改結束 (2/2) --------------------
         
           /*
           function checkUpdate() {
             google.script.run.withSuccessHandler(function(time) {
               console.log("取得時間：", time);
         
               if (window.lastUpdate && window.lastUpdate !== time) {
                 updateApp(); // 資料有更新，重整
               }
               window.lastUpdate = time;
             }).getLastUpdateTime();
           }
           setInterval(checkUpdate, 60 * 1000); // 每 60 秒檢查一次
           */
         
           // 第一次載入時馬上更新一次
           updateApp();
         }
         
         
         function renderFaqs(faqs) {
           return faqs.map(faq => `
             <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
               <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">
                   ${faq.question}</summary>
               <div class="mt-4 text-gray-700 leading-snug">
                 ${faq.answer
                   .replace(/\n/g, '<br>')
                   .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
                 }
                </div>
             </details>
           `).join('');
         }
         
         function renderEventBlocks(dataArray, blockPrefix) {
           return dataArray.map((e, index) => {
             const warningText = e.warning
               ? `${
                   e.warning
                     .replace(/\n/g, '<br>')
                     .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
                     .replace(/<a\b([^>]*)>/g, '<a style="color: blue; text-decoration: underline;" $1>')
                 }<br>`
               : '';
         
             const formattedDescription = e.description
               .replace(/\n/g, '<br>')
               .replace(/\?([^?]+)\?/g, '<span style="background-color: red; color: white; padding: 2px 4px; border-radius: 4px;">?$1?</span>')
               .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
               .replace(/\[佛光卡\]/g, '<span style="color: green; font-weight: bold;">[佛光卡]</span>')
               .replace(/\[三聯單\]/g, '<span style="color: green; font-weight: bold;">[三聯單]</span>')
               .replace(/\[百萬人興學三聯單\]/g, '<span style="color: green; font-weight: bold;">[百萬人興學三聯單]</span>');
         
             let moreButton = '';
             let detailContent = '';
             if (e.detail) {
               moreButton = `<button onclick="toggleDetails('${blockPrefix}-${index}')" class="text-indigo-600 text-lg md:text-5xl lg:text-xl mt-2">更多</button>`;
               detailContent = `<div id="detail-${blockPrefix}-${index}" class="mt-2 text-gray-500 text-lg md:text-5xl lg:text-xl hidden !leading-relaxed">${e.detail.replace(/\n/g, '<br>')}</div>`;
             }
         
             return `
         <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
         <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">${e.title}</summary>
         
         <div class="text-red-700  mt-4  leading-snug">${warningText}</div>
         
         <div class="mt-4 text-gray-700 leading-snug">${formattedDescription}</div>
         <br>
         ${moreButton}
         ${detailContent}
         </details>
         `;
           }).join('');
         }
         
         function toggleDetails(id) {
           const detailDiv = document.getElementById(`detail-${id}`);
           if (detailDiv) {
             detailDiv.classList.toggle('hidden');
           }
         }
         
         function toggleAnnualEvents() {
         const block = document.getElementById("annualEventsBlocks");
         const button = document.getElementById("toggleAnnualBtn");
         
         const isHidden = block.classList.contains("hidden");
         block.classList.toggle("hidden");

         button.textContent = isHidden ? "收起 ▲" : "展開 ▼";
         }
         
         function toggleSection(sectionId, buttonId) {
         const section = document.getElementById(sectionId);
         const button = document.getElementById(buttonId);
         
         const isHidden = section.classList.contains("hidden");
         section.classList.toggle("hidden");
         
         button.textContent = isHidden ? "收起 ▲" : "展開 ▼";
         }
         
         function logout() {
           localStorage.removeItem("isLoggedIn");
           localStorage.removeItem("loginTime");
           localStorage.removeItem("token");
           location.reload();
         }
      </script>
   </body>
</html>
