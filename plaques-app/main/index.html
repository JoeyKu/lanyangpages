<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法會功德登認系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }
        .container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            position: relative; /* Needed for positioning the menu */
        }
        h2, h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="tel"],
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .form-hint {
            color: #d9534f;
            font-style: italic;
            margin-top: 0.25rem;
            font-size: 0.9em;
            display: block;
        }
        .radio-group label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .toggle-link {
            text-align: center;
            margin-top: 1rem;
        }
        .toggle-link a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        #plaque-section h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        #plaque-list {
            list-style: none;
            padding: 0;
        }
        #plaque-list li {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .plaque-name {
            flex-grow: 1;
            word-break: break-all;
        }
        #plaque-list li:hover {
            background-color: #e9ecef;
        }
        .list-item-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .list-item-actions button {
            width: auto;
            margin: 0;
            padding: 4px 8px;
            font-size: 0.8em;
        }
        .copy-plaque-btn {
            background-color: #17a2b8;
        }
        .copy-plaque-btn:hover {
            background-color: #138496;
        }
        .delete-plaque-btn {
            background-color: #dc3545;
        }
        .delete-plaque-btn:hover {
            background-color: #c82333;
        }
        .plaque-entry {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1.5rem;
            margin-top: 1rem;
            position: relative;
        }
        .plaque-entry-header {
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .remove-plaque-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 30px;
            text-align: center;
            padding: 0;
        }
        #add-plaque-btn, #add-benefactor-plaque-btn {
            background-color: #28a745;
            margin-top: 1rem;
        }
        #add-plaque-btn:hover, #add-benefactor-plaque-btn:hover {
            background-color: #218838;
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        #cancel-plaque-form, #back-to-edit-btn, #cancel-benefactor-form, .back-to-list-btn {
            background-color: #6c757d;
        }
        #cancel-plaque-form:hover, #back-to-edit-btn:hover, #cancel-benefactor-form:hover, .back-to-list-btn:hover {
            background-color: #5a6268;
        }
        .fieldset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .btn-load-info {
            width: auto; padding: 4px 10px; font-size: 0.8em; background-color: #17a2b8; margin: 0;
        }
        
        .benefactor-grid {
            display: grid;
            /* 讓網格自動決定如何創建行 */
            /* 重要：如果 `grid-auto-flow: column;`，則 `grid-template-rows` 是更關鍵的 */
            /* 如果有20個項目，我們希望有4列，每列5個。所以我們需要5行 */
            grid-template-rows: repeat(5, auto); /* 定義5行，每行高度自動 */
            /* 讓項目優先沿著列（垂直方向）排列，填滿一行後換到下一列 */
            grid-auto-flow: column; 
            gap: 10px; /* 保持網格項目間距 */
            /* 確保網格容器不會過度拉伸 */
            width: 100%; /* 讓網格佔滿父容器寬度 */
            max-width: 700px; /* 或您希望的最大寬度 */
            /* 為了讓 4 欄能在必要時換行，我們需要讓容器允許換行，但這與 grid-auto-flow: column 有衝突 */
            /* 實際應用中，如果需要換行，通常會改用 flexbox 或調整 grid-template-columns */

            /* 如果想讓它最多只有4欄，且每欄5個輸入框，那麼 `grid-template-rows` 配合 `grid-auto-flow: column` 是正解 */
            /* 為了確保內容不被截斷，同時也確保每列寬度適中 */
            /* 假設我們有20個項目，5行，每行有一個項目，總共4列。 */
            /* 每列的寬度會自動調整，但為了顯示4列，我們需要確保有足夠的水平空間 */
            
            /* 重新調整思考方向: 如果要 4 列，並且內容垂直填充，最直接的方式是定義列數，然後讓內容流動 */
            /* 但 grid-auto-flow: column 確實是優先垂直填充 */
            /* 嘗試將 grid-template-columns 移除，讓 grid-auto-columns 處理列的生成，並限制每列的寬度 */
            grid-template-columns: repeat(4, 1fr); /* 重新引入 4 列的定義 */
            /* 如果這樣還不行，那就是寬度問題。需要為每個 input 定義一個 max-width */
        }
        #benefactor-entries-container.benefactor-grid > input {
            /* 讓輸入框填滿其所在的網格單元 */
            width: 100%; 
            padding: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box; /* 確保 padding 和 border 包含在 width 內 */
            /* 確保內容不會被截斷 */
            min-width: 0; /* 允許項目在必要時縮小，但通常不是問題的根源 */
            overflow: hidden; /* 防止內容溢出 */
            text-overflow: ellipsis; /* 如果內容太長，顯示省略號 */
            white-space: nowrap; /* 確保文本不換行，只在必要時顯示省略號 */
        }
        .terms-group {
            display: flex;
            align-items: flex-start;
            margin-top: 1rem;
            font-size: 0.9em;
        }
        .terms-group input {
            margin-right: 10px;
            margin-top: 3px;
        }

        /* 預覽畫面樣式 */
        #preview-section, #read-only-preview-section {
            border: 1px solid #ccc;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: #fafafa;
        }
        #preview-section h3, #preview-section h4, #read-only-preview-section h3, #read-only-preview-section h4 {
            text-align: left;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .preview-item {
            display: flex;
            margin-bottom: 0.5rem;
            align-items: flex-start;
        }
        .preview-item-label {
            font-weight: bold;
            width: 130px;
            color: #555;
            flex-shrink: 0;
        }
        
        /* 通知橫幅樣式 */
        #notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            text-align: center;
            color: white;
            z-index: 1000;
            box-sizing: border-box;
            transform: translateY(-100%);
            transition: transform 0.4s ease-in-out;
        }
        #notification-banner.show {
            transform: translateY(0);
        }
        #notification-banner.success {
            background-color: #28a745;
        }
        #notification-banner.error {
            background-color: #dc3545;
        }
        #notification-close {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            margin: 0;
            width: auto;
        }

        /* 預覽表格樣式 */
        .preview-table-section {
            margin-top: 2rem;
        }
        .preview-table-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .preview-table-section th,
        .preview-table-section td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
        }
        .preview-table-section th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* 載入中指示器樣式 */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            display: none; /* 預設隱藏 */
            justify-content: center;
            align-items: center;
        }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 右上角選單樣式 */
        .header-menu {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
        }
        .menu-toggle-btn {
            background: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 10px;
            width: auto;
            margin: 0;
        }
        .menu-toggle-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background-color: #333;
            margin: 5px 0;
            transition: 0.3s;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            overflow: hidden;
        }
        .dropdown-menu a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }
        .dropdown-menu a:hover {
            background-color: #f1f1f1;
        }
        .dropdown-menu.show {
            display: block;
        }

    </style>
</head>
<body>    
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>
    
    <div id="notification-banner">
        <span id="notification-message"></span>
        <button id="notification-close">&times;</button>
    </div>

    <div class="container">
        <!-- Login Form -->
        <div id="login-form">
            <h2>登入</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="login-user-id">使用者帳號</label>
                    <input type="text" id="login-user-id" required>
                </div>
                <div class="form-group">
                    <label for="login-password">密碼</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">登入</button>
            </form>
            <div class="toggle-link">
                <a onclick="toggleForms()">還沒有帳號？建立一個</a>
            </div>
        </div>

        <!-- Create Account Form -->
        <div id="create-account-form" class="hidden">
            <h2>建立帳號</h2>
            <form onsubmit="createAccount(event)">
                <div class="form-group">
                    <label for="create-user-id">新使用者帳號 (僅限英文、數字與.)</label>
                    <input type="text" id="create-user-id" required pattern="[a-zA-Z0-9.]+" title="帳號只能包含英文、數字與.">
                </div>
                <div class="form-group">
                    <label for="create-password">密碼</label>
                    <input type="password" id="create-password" required>
                </div>
                <div class="form-group">
                    <label for="confirm-password">確認密碼</label>
                    <input type="password" id="confirm-password" required>
                    <small id="password-match-error" class="form-hint" style="display: none; color: #dc3545;">兩次輸入的密碼不一致</small>
                </div>
                <div class="terms-group">
                    <input type="checkbox" id="terms-agree" onchange="toggleCreateAccountButton()">
                    <label for="terms-agree">註冊即表示您同意我們儲存您的資料，以提供服務。您的資料將被妥善保管，並僅供您本人使用。</label>
                </div>
                <button type="submit" id="create-account-btn" disabled>建立</button>
            </form>
            <div class="toggle-link">
                <a onclick="toggleForms()">已經有帳號了？登入</a>
            </div>
        </div>

        <!-- Plaque Main Section -->
        <div id="plaque-section" class="hidden">
            <div class="header-menu">
                <button id="menu-toggle-btn" class="menu-toggle-btn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div id="dropdown-menu" class="dropdown-menu">
                    <a href="#" onclick="event.preventDefault(); showUserProfile();">修改個人資料</a>
                    <a href="#" onclick="event.preventDefault(); logout();">登出</a>
                </div>
            </div>

            <h2>法會功德登記資訊</h2>
            <div class="form-group" style="margin-top: 2rem;">
                <label for="search-input">搜尋功德登記表名稱</label>
                <input type="text" id="search-input" onkeyup="filterPlaqueList()" placeholder="請輸入關鍵字...">
            </div>

            <h3>功德登記表清單:</h3>
            <ul id="plaque-list"></ul>

            <button onclick="showPlaqueForm()">新增功德資訊(大中小牌)</button>
            <button onclick="showBenefactorForm()">新增功德資訊(懺主)</button>
        </div>
        
        <!-- User Profile Section -->
        <div id="user-profile-section" class="hidden">
            <h2>個人資料管理</h2>
            <form onsubmit="updateUserProfile(event)">
                <fieldset>
                    <legend><strong>基本資料</strong></legend>
                    <div class="form-group">
                        <label for="profile-user-id">使用者帳號</label>
                        <input type="text" id="profile-user-id" disabled>
                    </div>
                    <div class="form-group">
                        <label for="profile-user-name">姓名</label>
                        <input type="text" id="profile-user-name" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-user-phone">電話</label>
                        <input type="tel" id="profile-user-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="profile-user-address">地址</label>
                        <input type="text" id="profile-user-address" required>
                    </div>
                    <button type="submit">儲存基本資料</button>
                </fieldset>
            </form>

            <form onsubmit="changePassword(event)" style="margin-top: 2rem;">
                <fieldset>
                    <legend><strong>更改密碼</strong></legend>
                     <div class="form-group">
                        <label for="current-password">目前密碼</label>
                        <input type="password" id="current-password" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">新密碼</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">確認新密碼</label>
                        <input type="password" id="confirm-new-password" required>
                    </div>
                    <button type="submit" style="background-color: #ffc107;">確認更改密碼</button>
                </fieldset>
            </form>

            <button type="button" class="back-to-list-btn" onclick="hideUserProfile()" style="margin-top: 2rem;">返回列表</button>
        </div>

        <!-- Add/Edit Plaque Form Section -->
        <div id="plaque-form-section" class="hidden">
            <h3 id="form-title">法會超薦資料</h3>
            <form id="main-plaque-form">
                <input type="hidden" id="plaque-id">
                <div class="form-group">
                    <label for="plaque-name">顯示名稱</label>
                    <input type="text" id="plaque-name" placeholder="例如: 地藏法會超薦資料" required>
                </div>
                
                <fieldset>
                    <div class="fieldset-header">
                        <legend><strong>基本資料</strong></legend>
                        <button type="button" class="btn-load-info" onclick="loadBasicInfo('plaque')">載入基本資料</button>
                    </div>
                    <div class="form-group">
                        <label for="user_name">姓名</label>
                        <input type="text" id="user_name" required>
                    </div>
                    <div class="form-group">
                        <label for="user_phone">電話</label>
                        <input type="tel" id="user_phone" required>
                    </div>
                    <div class="form-group">
                        <label for="user_address">地址</label>
                        <input type="text" id="user_address" required>
                    </div>
                    <div class="form-group">
                    <label for="dharma-name">法會名稱</label>
                        <select id="dharma-name" onchange="handleDharmaNameChange(this, 'dharma-name-other-input')">
                            <option value="地藏法會">地藏法會</option>
                            <option value="彌陀法會">彌陀法會</option>
                            <option value="其它">其它(需註明)</option>
                        </select>
                    </div>
                </fieldset>

                <fieldset>
                    <legend><strong>牌位資訊</strong></legend>
                    <div id="plaque-entries-container"></div>
                    <button type="button" id="add-plaque-btn" onclick="addPlaqueEntry('plaque-entries-container')">新增一筆牌位</button>
                </fieldset>

                <div class="form-actions">
                    <button type="button" onclick="generatePreview()">預覽資料</button>
                    <button type="button" id="cancel-plaque-form" onclick="hidePlaqueForm()">取消</button>
                </div>
            </form>
        </div>

        <!-- Benefactor Form Section -->
        <div id="benefactor-form-section" class="hidden">
            <h3 id="benefactor-form-title">新增牌位資訊(懺主)</h3>
            <form id="benefactor-plaque-form">
                <input type="hidden" id="benefactor-plaque-id">
                <div class="form-group">
                    <label for="benefactor-plaque-name">名稱</label>
                    <input type="text" id="benefactor-plaque-name" placeholder="例如: 地藏法會懺主" required>
                </div>
                
                <fieldset>
                     <div class="fieldset-header">
                        <legend><strong>基本資料</strong></legend>
                        <button type="button" class="btn-load-info" onclick="loadBasicInfo('benefactor')">載入基本資料</button>
                    </div>
                    <div class="form-group">
                        <label for="benefactor-user-name">姓名</label>
                        <input type="text" id="benefactor-user-name" required>
                    </div>
                    <div class="form-group">
                        <label for="benefactor-user-phone">電話</label>
                        <input type="tel" id="benefactor-user-phone" required>
                    </div>
                    <div class="form-group">
                        <label for="benefactor-user-address">地址</label>
                        <input type="text" id="benefactor-user-address" required>
                    </div>
                    <div class="form-group">
                    <label for="benefactor-dharma-name">法會名稱</label>
                        <select id="benefactor-dharma-name" onchange="handleDharmaNameChange(this, 'benefactor-dharma-name-other-input')">
                            <option value="地藏法會">地藏法會</option>
                            <option value="彌陀法會">彌陀法會</option>
                            <option value="其它">其它(需註明)</option>
                        </select>
                    </div>
                </fieldset>

                <fieldset>
                    <legend><strong>懺主類型</strong></legend>
                    <div class="radio-group">
                        <label><input type="radio" name="benefactor-type" value="two_large" onchange="handleBenefactorTypeChange(this.value)" checked> 20個消災+2支大牌</label>
                        <label><input type="radio" name="benefactor-type" value="three_large" onchange="handleBenefactorTypeChange(this.value)"> 3支大牌</label>
                    </div>
                </fieldset>

                <fieldset id="benefactor-entries-section" class="hidden">
                    <legend><strong>消災資訊</strong></legend>
                    <div id="benefactor-entries-container" class="benefactor-grid"></div>
                </fieldset>
                
                <fieldset>
                    <legend><strong>牌位資訊</strong></legend>
                    <small id="benefactor-plaque-hint" class="form-hint"></small>
                    <div id="benefactor-plaque-entries-container"></div>
                    <button type="button" id="add-benefactor-plaque-btn" onclick="addPlaqueEntry('benefactor-plaque-entries-container')">新增一筆牌位</button>
                </fieldset>

                <div class="form-actions">
                    <button type="button" onclick="generateBenefactorPreview()">預覽資料</button>
                    <button type="button" id="cancel-benefactor-form" onclick="hideBenefactorForm()">取消</button>
                </div>
            </form>
        </div>

        <!-- Read-only Preview Section -->
        <div id="read-only-preview-section" class="hidden">
            <h3>功德登記表預覽</h3>
            <input type="hidden" id="readonly-plaque-id">
            <input type="hidden" id="readonly-plaque-type">
            
            <h4>基本資料</h4>
            <div class="preview-item">
                <div class="preview-item-label">名稱:</div>
                <div id="readonly-plaque-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">姓名:</div>
                <div id="readonly-user-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">電話:</div>
                <div id="readonly-user-phone"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">地址:</div>
                <div id="readonly-user-address"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">法會名稱:</div>
                <div id="readonly-dharma-name"></div>
            </div>
            
            <div id="readonly-benefactor-list-section" class="hidden">
                <h4>消災資訊:</h4>
                <p id="readonly-benefactor-list" style="word-break: break-all;"></p>
            </div>
            
            <div id="readonly-big-section" class="preview-table-section">
                <h4>您的大牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="readonly-big-tbody"></tbody>
                </table>
            </div>
            <div id="readonly-medium-section" class="preview-table-section">
                <h4>您的中牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="readonly-medium-tbody"></tbody>
                </table>
            </div>
            <div id="readonly-small-section" class="preview-table-section">
                <h4>您的小牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="readonly-small-tbody"></tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="button" onclick="goToEditMode()">前往修改</button>
                <button type="button" onclick="downloadPDF()">下載 PDF</button>
            </div>
             <div class="form-actions">
                <button type="button" class="back-to-list-btn" onclick="showPlaqueSectionView(localStorage.getItem('user_id'))">返回列表</button>
            </div>
        </div>


        <!-- Preview Section (for editing) -->
        <div id="preview-section" class="hidden">
            <h3>資料預覽</h3>
            <input type="hidden" id="preview-mode">
            
            <h4>基本資料</h4>
            <div class="preview-item">
                <div class="preview-item-label">顯示名稱:</div>
                <div id="preview-plaque-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">姓名:</div>
                <div id="preview-user-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">電話:</div>
                <div id="preview-user-phone"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">地址:</div>
                <div id="preview-user-address"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">法會名稱:</div>
                <div id="preview-dharma-name"></div>
            </div>
            
            <div id="preview-benefactor-list-section" class="hidden">
                <h4>消災資訊:</h4>
                <p id="preview-benefactor-list" style="word-break: break-all;"></p>
            </div>
            
            <div id="preview-big-section" class="preview-table-section">
                <h4>您的大牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-big-tbody"></tbody>
                </table>
            </div>
            <div id="preview-medium-section" class="preview-table-section">
                <h4>您的中牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-medium-tbody"></tbody>
                </table>
            </div>
            <div id="preview-small-section" class="preview-table-section">
                <h4>您的小牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-small-tbody"></tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="button" onclick="submitData()">確認儲存</button>
                <button type="button" id="back-to-edit-btn" onclick="backToEdit()">返回修改</button>
            </div>
        </div>
    </div>

    <script>
        //const API_BASE_URL = 'https://f5opovf0if.execute-api.ap-east-2.amazonaws.com/Prod';
        const API_BASE_URL = 'http://127.0.0.1:3000'

        // --- Global State ---
        let plaqueEntryCounter = 0;
        let notificationTimeout;

        // --- DOM Elements ---
        const loginForm = document.getElementById('login-form');
        const createAccountForm = document.getElementById('create-account-form');
        const plaqueSection = document.getElementById('plaque-section');
        const userProfileSection = document.getElementById('user-profile-section');
        const plaqueFormSection = document.getElementById('plaque-form-section');
        const benefactorFormSection = document.getElementById('benefactor-form-section');
        const previewSection = document.getElementById('preview-section');
        const readOnlyPreviewSection = document.getElementById('read-only-preview-section');
        const plaqueList = document.getElementById('plaque-list');
        const plaqueEntriesContainer = document.getElementById('plaque-entries-container');
        const notificationBanner = document.getElementById('notification-banner');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');

        // --- Notification Banner ---
        function showNotification(message, type = 'success') {
            clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            notificationBanner.className = '';
            notificationBanner.classList.add(type, 'show');
            notificationTimeout = setTimeout(() => {
                notificationBanner.classList.remove('show');
            }, 4000);
        }
        notificationClose.addEventListener('click', () => {
            clearTimeout(notificationTimeout);
            notificationBanner.classList.remove('show');
        });

        // --- Loader ---
        function showLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'flex';
        }
        function hideLoader() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        // --- Authentication & View Management ---
        function showLoginView() {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_id');
            document.getElementById('login-user-id').value = '';
            document.getElementById('login-password').value = '';
            plaqueSection.classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            userProfileSection.classList.add('hidden');
            benefactorFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            readOnlyPreviewSection.classList.add('hidden');
            loginForm.classList.remove('hidden');
            createAccountForm.classList.add('hidden');
            plaqueList.innerHTML = '';
        }
        
        function handleUnauthorized(response) {
            if (response.status === 401) {
                showLoginView();
                showNotification('登入已過期，請重新登入。', 'error');
                return true;
            }
            return false;
        }

        function toggleForms() {
            // Reset terms checkbox when switching to create account form
            document.getElementById('terms-agree').checked = false;
            toggleCreateAccountButton(); // Ensure button state is correct
            loginForm.classList.toggle('hidden');
            createAccountForm.classList.toggle('hidden');
        }

        async function login(event) {
            event.preventDefault();
            const userId = document.getElementById('login-user-id').value;
            const password = document.getElementById('login-password').value;
            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password }),
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('jwt_token', data.token);
                    localStorage.setItem('user_id', userId);
                    showPlaqueSectionView(userId);
                } else {
                    showNotification('登入失敗: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('登入時發生錯誤:', error);
                showNotification('登入時發生錯誤，請查看主控台。', 'error');
            } finally {
                hideLoader();
            }
        }

        async function createAccount(event) {
            event.preventDefault();
            const userId = document.getElementById('create-user-id').value;
            const password = document.getElementById('create-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const passwordError = document.getElementById('password-match-error');

            // 檢查：帳號格式 (只能是英文、數字、點)
            const userIdRegex = /^[a-zA-Z0-9.]+$/;
            if (!userIdRegex.test(userId)) {
                showNotification('帳號格式錯誤，只能使用英文、數字與.', 'error');
                return;
            }

            // 檢查：兩次密碼是否相符
            if (password !== confirmPassword) {
                passwordError.style.display = 'block';
                showNotification('兩次輸入的密碼不一致', 'error');
                return;
            }
            passwordError.style.display = 'none';

            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password }),
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification('帳號建立成功！請登入。', 'success');
                    toggleForms();
                } else {
                    showNotification('建立帳號失敗: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('建立帳號時發生錯誤:', error);
                showNotification('建立帳號時發生錯誤，請查看主控台。', 'error');
            } finally {
                hideLoader();
            }
        }
        
        function toggleCreateAccountButton() {
            const checkbox = document.getElementById('terms-agree');
            const button = document.getElementById('create-account-btn');
            button.disabled = !checkbox.checked;
        }

        async function fetchPlaques(userId) {
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques?user_id=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    const data = await response.json();
                    plaqueList.innerHTML = '';
                    if (data.plaques && data.plaques.length > 0) {
                        data.plaques.forEach(plaque => {
                            const li = document.createElement('li');
                            li.onclick = () => handleListItemClick(plaque.timestamp, plaque.plaque_type);

                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'plaque-name';
                            const plaqueType = plaque.plaque_type || '一般';
                            nameSpan.textContent = `[${plaqueType}] ${plaque.plaque_name}`;

                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'list-item-actions';

                            const copyBtn = document.createElement('button');
                            copyBtn.textContent = '複製';
                            copyBtn.className = 'copy-plaque-btn';
                            copyBtn.onclick = (event) => {
                                event.stopPropagation();
                                copyPlaque(plaque.timestamp, plaque.plaque_name);
                            };

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = '刪除';
                            deleteBtn.className = 'delete-plaque-btn';
                            deleteBtn.onclick = (event) => {
                                event.stopPropagation();
                                deletePlaque(plaque.timestamp, plaque.plaque_name);
                            };
                            
                            actionsDiv.appendChild(copyBtn);
                            actionsDiv.appendChild(deleteBtn);
                            
                            li.appendChild(nameSpan);
                            li.appendChild(actionsDiv);
                            
                            plaqueList.appendChild(li);
                        });
                    } else {
                        plaqueList.innerHTML = '<li>尚無牌位資料</li>';
                    }
                } else {
                    console.error('獲取牌位資料失敗:', await response.text());
                }
            } catch (error) {
                console.error('獲取牌位資料時發生錯誤:', error);
            } finally {
                hideLoader();
            }
        }
        
        function filterPlaqueList() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const ul = document.getElementById('plaque-list');
            const liItems = ul.getElementsByTagName('li');

            for (let i = 0; i < liItems.length; i++) {
                const nameSpan = liItems[i].querySelector('.plaque-name');
                if (nameSpan) {
                    const txtValue = nameSpan.textContent || nameSpan.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        liItems[i].style.display = "flex";
                    } else {
                        liItems[i].style.display = "none";
                    }
                }
            }
        }

        function showPlaqueSectionView(userId) {
            loginForm.classList.add('hidden');
            createAccountForm.classList.add('hidden');
            userProfileSection.classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            benefactorFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            readOnlyPreviewSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
            document.getElementById('search-input').value = '';
            // Proactively clean up forms to prevent state leakage
            hidePlaqueForm();
            hideBenefactorForm();

            fetchPlaques(userId);
        }
        
        function logout() {
            const dropdownMenu = document.getElementById('dropdown-menu');
            if (dropdownMenu) dropdownMenu.classList.remove('show');
            showLoginView();
            showNotification('您已登出。', 'success');
        }
        
        // --- Form Views Logic ---
        function showPlaqueForm() {
            plaqueSection.classList.add('hidden');
            userProfileSection.classList.add('hidden');
            benefactorFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            readOnlyPreviewSection.classList.add('hidden');
            plaqueFormSection.classList.remove('hidden');
            
            document.getElementById('plaque-name').value = '';
            document.getElementById('user_name').value = '';
            document.getElementById('user_phone').value = '';
            document.getElementById('user_address').value = '';

            document.getElementById('plaque-id').value = '';
            document.getElementById('benefactor-plaque-id').value = '';
            document.getElementById('form-title').textContent = "新增牌位資訊(大中小牌)";
            plaqueEntriesContainer.innerHTML = '';
            plaqueEntryCounter = 0;
            addPlaqueEntry('plaque-entries-container');
        }

        function hidePlaqueForm() {
            // Perform a full cleanup when canceling
            document.getElementById('plaque-name').value = '';
            document.getElementById('user_name').value = '';
            document.getElementById('user_phone').value = '';
            document.getElementById('user_address').value = '';
            plaqueEntriesContainer.innerHTML = '';
            plaqueEntryCounter = 0;
            plaqueFormSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
        }

        function showBenefactorForm() {
            plaqueSection.classList.add('hidden');
            userProfileSection.classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            readOnlyPreviewSection.classList.add('hidden');
            benefactorFormSection.classList.remove('hidden');
            
            document.getElementById('benefactor-plaque-name').value = '';
            document.getElementById('benefactor-user-name').value = '';
            document.getElementById('benefactor-user-phone').value = '';
            document.getElementById('benefactor-user-address').value = '';
            document.getElementById('plaque-id').value = '';
            document.getElementById('benefactor-plaque-id').value = '';
            document.getElementById('benefactor-form-title').textContent = "新增牌位資訊(懺主)";
            document.getElementById('benefactor-plaque-entries-container').innerHTML = '';
            plaqueEntryCounter = 0;
            
            handleBenefactorTypeChange(document.querySelector('input[name="benefactor-type"]:checked').value);
        }

        function hideBenefactorForm() {
            // Perform a full cleanup when canceling
            document.getElementById('benefactor-plaque-name').value = '';
            document.getElementById('benefactor-user-name').value = '';
            document.getElementById('benefactor-user-phone').value = '';
            document.getElementById('benefactor-user-address').value = '';
            document.getElementById('benefactor-entries-container').innerHTML = '';
            document.getElementById('benefactor-plaque-entries-container').innerHTML = '';
            plaqueEntryCounter = 0;
            benefactorFormSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
        }

        // --- User Profile View ---
        function showUserProfile() {
            const dropdownMenu = document.getElementById('dropdown-menu');
            if (dropdownMenu) dropdownMenu.classList.remove('show');
            plaqueSection.classList.add('hidden');
            userProfileSection.classList.remove('hidden');
            fetchAndDisplayProfile();
        }

        function hideUserProfile() {
            userProfileSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
        }

        async function fetchAndDisplayProfile() {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('jwt_token');
            if (!userId || !token) return;

            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取個人資料失敗');

                const data = await response.json();
                document.getElementById('profile-user-id').value = data.user_id || userId;
                document.getElementById('profile-user-name').value = data.user_name || '';
                document.getElementById('profile-user-phone').value = data.user_phone || '';
                document.getElementById('profile-user-address').value = data.user_address || '';
                
                // Clear password fields every time
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-new-password').value = '';

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("獲取個人資料時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }

        async function updateUserProfile(event) {
            event.preventDefault();
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('jwt_token');
            
            const profileData = {
                user_name: document.getElementById('profile-user-name').value,
                user_phone: document.getElementById('profile-user-phone').value,
                user_address: document.getElementById('profile-user-address').value,
            };

            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(profileData)
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('更新失敗');

                showNotification('基本資料更新成功！', 'success');
            } catch(error) {
                showNotification('更新失敗，請稍後再試。', 'error');
            } finally {
                hideLoader();
            }
        }

        async function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;

            if (!currentPassword || !newPassword) {
                showNotification('目前密碼與新密碼皆不可為空', 'error');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                showNotification('新密碼與確認密碼不一致', 'error');
                return;
            }

            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('jwt_token');

            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
                });
                 if (handleUnauthorized(response)) return;
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || '更改密碼失敗');

                alert('密碼已成功更改，為了安全起見，將為您自動登出。');
                logout();
            } catch(error) {
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }

        // --- Read-only Preview and Edit Logic ---
        async function handleListItemClick(id, type) {
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取資料失敗');
                
                const data = await response.json();
                populateReadOnlyPreview(data);

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("預覽時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }

        function populateReadOnlyPreview(data) {
            plaqueSection.classList.add('hidden');
            readOnlyPreviewSection.classList.remove('hidden');
            
            document.getElementById('readonly-plaque-id').value = data.timestamp;
            document.getElementById('readonly-plaque-type').value = data.plaque_type || '一般';

            document.getElementById('readonly-plaque-name').textContent = data.plaque_name || '';
            document.getElementById('readonly-user-name').textContent = data.user_name || '';
            document.getElementById('readonly-user-phone').textContent = data.user_phone || '';
            document.getElementById('readonly-user-address').textContent = data.user_address || '';
            document.getElementById('readonly-dharma-name').textContent = data.dharma_name || '';

            const benefactorListSection = document.getElementById('readonly-benefactor-list-section');
            if (data.plaque_type === '懺主' && data.misfortune_dispelling_data && data.misfortune_dispelling_data.length > 0) {
                document.getElementById('readonly-benefactor-list').textContent = data.misfortune_dispelling_data.join(', ');
                benefactorListSection.classList.remove('hidden');
            } else {
                benefactorListSection.classList.add('hidden');
            }
            
            populatePreviewTables(data.plaque_data, 'readonly');
        }

        function goToEditMode() {
            const id = document.getElementById('readonly-plaque-id').value;
            const type = document.getElementById('readonly-plaque-type').value;
            readOnlyPreviewSection.classList.add('hidden');

            if (type === '懺主') {
                editBenefactor(id);
            } else {
                editPlaque(id);
            }
        }

        async function loadBasicInfo(formPrefix) {
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('jwt_token');
            if (!userId || !token) return;
            
            showLoader();
            try {
                const response = await fetch(`${API_BASE_URL}/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取個人資料失敗');

                const data = await response.json();
                
                if (formPrefix === 'plaque') {
                    document.getElementById('user_name').value = data.user_name || '';
                    document.getElementById('user_phone').value = data.user_phone || '';
                    document.getElementById('user_address').value = data.user_address || '';
                } else if (formPrefix === 'benefactor') {
                    document.getElementById('benefactor-user-name').value = data.user_name || '';
                    document.getElementById('benefactor-user-phone').value = data.user_phone || '';
                    document.getElementById('benefactor-user-address').value = data.user_address || '';
                }
                showNotification('基本資料已載入', 'success');

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("載入基本資料時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }

        async function downloadPDF() {
            const id = document.getElementById('readonly-plaque-id').value;
            if (!id) {
                showNotification('找不到資料 ID', 'error');
                return;
            }
            
            const downloadUrl = `${API_BASE_URL}/forms/${id}`
            console.log(`準備從 ${downloadUrl} 下載 PDF`);

            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(downloadUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/pdf,application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (handleUnauthorized(response)) return;

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '伺服器發生未知錯誤' }));
                    throw new Error(`下載失敗: ${errorData.message}`);
                }

                const blob = await response.blob();

                const contentDisposition = response.headers.get('content-disposition');
                let filename = document.getElementById('readonly-user-name').innerHTML + '-' + 
                               document.getElementById('readonly-plaque-name').innerHTML + '.pdf';
                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename="?(.+)"?/);
                    if (filenameMatch && filenameMatch.length === 2) {
                        filename = filenameMatch[1];
                    }
                }

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                
                document.body.appendChild(a);
                a.click();
                
                window.URL.revokeObjectURL(url);
                a.remove();

                showNotification('PDF 下載已開始！', 'success');

            } catch (error) {
                console.error('下載 PDF 時發生錯誤:', error);
                showNotification(error.message, 'error');
            } finally {
                hideLoader();
            }
        }
        
        // --- Edit, Delete, Copy Logic ---
        async function editPlaque(id) {
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取資料失敗');
                
                const data = await response.json();
                populateFormWithData(data);

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("編輯時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }
        
        async function editBenefactor(id) {
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取懺主資料失敗');
                
                const data = await response.json();
                populateBenefactorFormWithData(data);

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("編輯懺主時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }
        
        async function deletePlaque(id, name) {
            if (!confirm(`您確定要刪除 "${name}" 嗎？此操作無法復原。`)) return;

            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    showNotification('牌位資料刪除成功！', 'success');
                    fetchPlaques(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('刪除失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('刪除時發生錯誤:', error);
                showNotification('刪除時發生錯誤。', 'error');
            } finally {
                hideLoader();
            }
        }
        
        async function copyPlaque(id, name) {
            if (!confirm(`您確定要複製 "${name}" 嗎？`)) return;
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                let response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取複製資料失敗');
                
                const dataToCopy = await response.json();
                
                dataToCopy.plaque_name = `${dataToCopy.plaque_name} - 複製`;
                delete dataToCopy.timestamp;

                response = await fetch(`${API_BASE_URL}/plaques`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToCopy)
                });

                if (handleUnauthorized(response)) return;
                
                if (response.ok) {
                    showNotification('牌位資料複製成功！', 'success');
                    fetchPlaques(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('複製失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }

            } catch (error) {
                showNotification(error.message, 'error');
                console.error("複製時發生錯誤:", error);
            } finally {
                hideLoader();
            }
        }

        function populateFormWithData(data) {
            showPlaqueForm();
            document.getElementById('form-title').textContent = "修改牌位資訊(大中小牌)";
            document.getElementById('plaque-id').value = data.timestamp;

            document.getElementById('plaque-name').value = data.plaque_name || '';
            document.getElementById('user_name').value = data.user_name || '';
            document.getElementById('user_phone').value = data.user_phone || '';
            document.getElementById('user_address').value = data.user_address || '';
            document.getElementById('dharma-name').value = data.dharma_name || '';

            plaqueEntriesContainer.innerHTML = '';
            plaqueEntryCounter = 0;

            if (data.plaque_data && data.plaque_data.length > 0) {
                data.plaque_data.forEach(item => {
                    addPlaqueEntry('plaque-entries-container');
                    const entryId = plaqueEntryCounter;
                    const entryDiv = document.getElementById(`plaque-entry-${entryId}`);
                    
                    entryDiv.querySelector(`input[name="type-${entryId}"][value="${item.type}"]`).checked = true;
                    
                    const titleSelect = entryDiv.querySelector(`#title-${entryId}`);
                    const isStandardTitle = Array.from(titleSelect.options).some(opt => opt.value === item.item_title);

                    titleSelect.value = isStandardTitle ? item.item_title : 'other';
                    handleTitleChange(titleSelect);

                    if (!isStandardTitle) {
                        const otherInput = entryDiv.querySelector('.title-other-input');
                        if (otherInput) otherInput.value = item.item_title;
                    }
                    
                    entryDiv.querySelector(`#deceased-${entryId}`).value = item.item_name;
                    entryDiv.querySelector(`#sponsor-${entryId}`).value = item.item_benefactor;
                });
             } else {
                addPlaqueEntry('plaque-entries-container');
             }

            // Correctly populate dharma_name for editing
            const dharmaSelect = document.getElementById('dharma-name');
            const standardDharmaNames = Array.from(dharmaSelect.options).map(opt => opt.value);
            if (data.dharma_name && standardDharmaNames.includes(data.dharma_name)) {
                dharmaSelect.value = data.dharma_name;
            } else if (data.dharma_name) {
                dharmaSelect.value = '其它';
                handleDharmaNameChange(dharmaSelect, 'dharma-name-other-input');
                const otherInput = document.getElementById('dharma-name-other-input');
                if (otherInput) otherInput.value = data.dharma_name;
            //} else {
            //    addPlaqueEntry('plaque-entries-container');
            }
        }

        function populateBenefactorFormWithData(data) {
            showBenefactorForm();
            document.getElementById('benefactor-form-title').textContent = "修改牌位資訊(懺主)";
            document.getElementById('benefactor-plaque-id').value = data.timestamp;
            
            document.getElementById('benefactor-plaque-name').value = data.plaque_name || '';
            document.getElementById('benefactor-user-name').value = data.user_name || '';
            document.getElementById('benefactor-user-phone').value = data.user_phone || '';
            document.getElementById('benefactor-user-address').value = data.user_address || '';
            document.getElementById('benefactor-dharma-name').value = data.dharma_name || '';
            
            const benefactorType = data.plaque_subtype || 'three_large';
            
            document.querySelector(`input[name="benefactor-type"][value="${benefactorType}"]`).checked = true;
            handleBenefactorTypeChange(benefactorType);

            if (data.misfortune_dispelling_data && data.misfortune_dispelling_data.length > 0) {
                const benefactorInputs = document.getElementById('benefactor-entries-container').getElementsByTagName('input');
                for (let i = 0; i < data.misfortune_dispelling_data.length; i++) {
                    if (benefactorInputs[i]) {
                        benefactorInputs[i].value = data.misfortune_dispelling_data[i];
                    }
                }
            }

            const plaqueContainer = document.getElementById('benefactor-plaque-entries-container');
            plaqueContainer.innerHTML = '';
            plaqueEntryCounter = 0;

            if (data.plaque_data && data.plaque_data.length > 0) {
                data.plaque_data.forEach(item => {
                    addPlaqueEntry('benefactor-plaque-entries-container');
                    const entryId = plaqueEntryCounter;
                    const entryDiv = document.getElementById(`plaque-entry-${entryId}`);

                    entryDiv.querySelector(`input[name="type-${entryId}"][value="${item.type}"]`).checked = true;
                    
                    const titleSelect = entryDiv.querySelector(`#title-${entryId}`);
                    const isStandardTitle = Array.from(titleSelect.options).some(opt => opt.value === item.item_title);

                    titleSelect.value = isStandardTitle ? item.item_title : 'other';
                    handleTitleChange(titleSelect);

                    if (!isStandardTitle) {
                        const otherInput = entryDiv.querySelector('.title-other-input');
                        if (otherInput) otherInput.value = item.item_title;
                    }
                    
                    entryDiv.querySelector(`#deceased-${entryId}`).value = item.item_name;
                    entryDiv.querySelector(`#sponsor-${entryId}`).value = item.item_benefactor;
                });
            }
        }


        // --- Dynamic Form Entry ---
        function handleTitleChange(selectElement) {
            const selectedValue = selectElement.value;
            const entryDiv = selectElement.closest('.plaque-entry');
            if (!entryDiv) return;

            const deceasedInput = entryDiv.querySelector('[id^="deceased-"]');
            const hintElement = entryDiv.querySelector('[id^="hint-"]');
            
            const existingOtherInput = entryDiv.querySelector('.title-other-input');
            if (existingOtherInput) existingOtherInput.remove();

            deceasedInput.disabled = false;
            deceasedInput.value = '';
            hintElement.textContent = '';
            deceasedInput.placeholder = '';

            switch (selectedValue) {
                case '歷代祖先': hintElement.textContent = '請於下方欄位填寫「姓氏」'; break;
                case '地基主': hintElement.textContent = '請於下方欄位填寫「地址」'; break;
                case '未出世子女': case '累劫冤親債主': case '十方法界一切眾生':
                    hintElement.textContent = '（此項無需填寫）';
                    deceasedInput.value = 'None';
                    deceasedInput.disabled = true;
                    break;
                case '父': case '母': case '祖父': case '祖母':
                    hintElement.textContent = '請於下方欄位填寫「姓名」';
                    break;
                case '兄': case '弟': case '姊': case '妹': case '子': case '女':
                    hintElement.textContent = '請於下方欄位填寫「姓名」並註明是否已婚';
                    break;
                case 'other':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = '請註明稱謂';
                    input.className = 'title-other-input';
                    input.style.marginTop = '0.5rem';
                    selectElement.parentNode.appendChild(input);
                    hintElement.textContent = '若是個人(如朋友)，請註明「性別」及是否已婚';
                    break;
            }
        }

        function addPlaqueEntry(containerId) {
            plaqueEntryCounter++;
            const entryId = plaqueEntryCounter;
            const container = document.getElementById(containerId);
            const entryDiv = document.createElement('div');
            entryDiv.className = 'plaque-entry';
            entryDiv.id = `plaque-entry-${entryId}`;
            entryDiv.innerHTML = `
                <div class="plaque-entry-header">牌位 #${container.children.length + 1}</div>
                ${container.children.length > 0 ? `<button type="button" class="remove-plaque-btn" onclick="removePlaqueEntry(${entryId})">X</button>` : ''}
                <div class="form-group">
                    <label>型別</label>
                    <div class="radio-group">
                        <label><input type="radio" name="type-${entryId}" value="小" checked> 小牌</label>
                        <label><input type="radio" name="type-${entryId}" value="中"> 中牌</label>
                        <label><input type="radio" name="type-${entryId}" value="大"> 大牌</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="title-${entryId}">稱謂</label>
                    <select id="title-${entryId}" onchange="handleTitleChange(this)">
                        <option value="歷代祖先">歷代祖先</option>
                        <option value="累劫冤親債主">累劫冤親債主</option>
                        <option value="地基主">地基主</option>
                        <option value="十方法界一切眾生">十方法界一切眾生</option>
                        <option value="未出世子女">未出世子女</option>
                        <option value="父">父</option> <option value="母">母</option>
                        <option value="兄">兄</option> <option value="弟">弟</option>
                        <option value="姊">姊</option> <option value="妹">妹</option>
                        <option value="祖父">祖父</option> <option value="祖母">祖母</option>
                        <option value="子">子</option> <option value="女">女</option>
                        <option value="other">其它(需註明)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deceased-${entryId}">亡者/項目/地址</label>
                    <small id="hint-${entryId}" class="form-hint"></small>
                    <input type="text" id="deceased-${entryId}" required>
                </div>
                <div class="form-group">
                    <label for="sponsor-${entryId}">陽上</label>
                    <input type="text" id="sponsor-${entryId}" required>
                </div>
            `;
            container.appendChild(entryDiv);
            const newSelect = document.getElementById(`title-${entryId}`);
            handleTitleChange(newSelect);


            if (containerId === 'benefactor-plaque-entries-container') {
                const radioButtons = entryDiv.querySelectorAll(`input[name="type-${entryId}"]`);
                radioButtons.forEach(radio => {
                    if (radio.value === '中') {
                        radio.parentElement.style.display = 'none';
                    }
                });
            }
        }
        
        function removePlaqueEntry(entryId) {
            const entry = document.getElementById(`plaque-entry-${entryId}`);
            if (entry) entry.remove();
        }

        function handleBenefactorTypeChange(type) {
            const benefactorEntriesSection = document.getElementById('benefactor-entries-section');
            const benefactorGrid = document.getElementById('benefactor-entries-container');
            const hintElement = document.getElementById('benefactor-plaque-hint');

            benefactorGrid.innerHTML = '';
            
            if (type === 'two_large') {
                benefactorEntriesSection.classList.remove('hidden');
                hintElement.textContent = '注意: 最多2支大牌 6支小牌';
                for (let i = 1; i <= 20; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = `消災 #${i}`;
                    benefactorGrid.appendChild(input);
                }
            } else { // three_large
                benefactorEntriesSection.classList.add('hidden');
                hintElement.textContent = '注意: 最多3支大牌 6支小牌';
            }
        }

        function handleDharmaNameChange(selectElement, otherInputId) {
            const existingOtherInput = document.getElementById(otherInputId);
            if (existingOtherInput) {
                existingOtherInput.remove();
            }

            if (selectElement.value === '其它') {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = '請註明法會名稱';
                input.id = otherInputId;
                input.className = 'form-group'; // Reuse existing style
                input.style.marginTop = '0.5rem';
                input.required = true;
                // Insert the new input field right after the select's parent div
                selectElement.parentNode.insertAdjacentElement('afterend', input);
            }
        }


        // --- Data Collection, Preview, and Submission ---
        function collectPlaquesFromContainer(containerId) {
            const plaqueData = [];
            const entries = document.getElementById(containerId).getElementsByClassName('plaque-entry');
            for (let entry of entries) {
                const titleSelect = entry.querySelector('[id^="title-"]');
                let apiTitle = titleSelect.value;
                if (apiTitle === 'other') {
                    const otherInput = entry.querySelector('.title-other-input');
                    apiTitle = otherInput ? otherInput.value.trim() : 'other';
                }
                plaqueData.push({
                    type: entry.querySelector('[name^="type-"]:checked').value,
                    item_title: apiTitle,
                    item_name: entry.querySelector('[id^="deceased-"]').value,
                    item_benefactor: entry.querySelector('[id^="sponsor-"]').value,
                });
            }
            return plaqueData;
        }

        function collectAndFormatData() {
            let dharmaName = document.getElementById('dharma-name').value;
            if (dharmaName === '其它') {
                const otherInput = document.getElementById('dharma-name-other-input');
                dharmaName = otherInput ? otherInput.value.trim() : '';
            }

            return {
                user_id: localStorage.getItem('user_id'),
                plaque_name: document.getElementById('plaque-name').value,
                plaque_type: "一般",
                user_name: document.getElementById('user_name').value,
                user_phone: document.getElementById('user_phone').value,
                user_address: document.getElementById('user_address').value,
                dharma_name: dharmaName,
                plaque_data: collectPlaquesFromContainer('plaque-entries-container')
            };
        }
        
        function collectBenefactorData() {
            const misfortuneData = [];
            const benefactorInputs = document.getElementById('benefactor-entries-container').getElementsByTagName('input');
            for(let input of benefactorInputs) {
                if(input.value.trim() !== '') {
                    misfortuneData.push(input.value.trim());
                }
            }
            let dharmaName = document.getElementById('benefactor-dharma-name').value;
            if (dharmaName === '其它') {
                const otherInput = document.getElementById('benefactor-dharma-name-other-input');
                dharmaName = otherInput ? otherInput.value.trim() : '';
            }

            return {
                user_id: localStorage.getItem('user_id'),
                plaque_name: document.getElementById('benefactor-plaque-name').value,
                plaque_type: "懺主",
                plaque_subtype: document.querySelector('input[name="benefactor-type"]:checked').value,
                user_name: document.getElementById('benefactor-user-name').value,
                user_phone: document.getElementById('benefactor-user-phone').value,
                user_address: document.getElementById('benefactor-user-address').value,
                dharma_name: dharmaName, // <-- 新增欄位
                misfortune_dispelling_data: misfortuneData,
                plaque_data: collectPlaquesFromContainer('benefactor-plaque-entries-container')
            };
        }

        function populatePreviewTables(plaques, prefix = 'preview') {
            const bigTbody = document.getElementById(`${prefix}-big-tbody`);
            const mediumTbody = document.getElementById(`${prefix}-medium-tbody`);
            const smallTbody = document.getElementById(`${prefix}-small-tbody`);
            bigTbody.innerHTML = ''; mediumTbody.innerHTML = ''; smallTbody.innerHTML = '';
            
            plaques.forEach(plaque => {
                const row = document.createElement('tr');
                const titleSelect = document.querySelector(`#main-plaque-form select option[value="${plaque.item_title}"]`);
                let titleText = plaque.item_title;
                if(plaque.item_title !== 'other' && titleSelect) {
                    titleText = titleSelect.textContent;
                }
                
                row.innerHTML = `<td>${titleText}</td><td>${plaque.item_name}</td><td>${plaque.item_benefactor}</td>`;
                if (plaque.type === '大') bigTbody.appendChild(row);
                else if (plaque.type === '中') mediumTbody.appendChild(row);
                else smallTbody.appendChild(row);
            });

            document.getElementById(`${prefix}-big-section`).style.display = bigTbody.children.length > 0 ? 'block' : 'none';
            document.getElementById(`${prefix}-medium-section`).style.display = mediumTbody.children.length > 0 ? 'block' : 'none';
            document.getElementById(`${prefix}-small-section`).style.display = smallTbody.children.length > 0 ? 'block' : 'none';
        }

        function generatePreview() {
            if (!document.getElementById('main-plaque-form').checkValidity()) {
                document.getElementById('main-plaque-form').reportValidity(); return;
            }
            document.getElementById('preview-mode').value = 'plaque';
            
            document.getElementById('preview-plaque-name').textContent = document.getElementById('plaque-name').value;
            document.getElementById('preview-user-name').textContent = document.getElementById('user_name').value;
            document.getElementById('preview-user-phone').textContent = document.getElementById('user_phone').value;
            document.getElementById('preview-user-address').textContent = document.getElementById('user_address').value;
            document.getElementById('preview-dharma-name').textContent = document.getElementById('dharma-name').value;
            
            const plaques = collectPlaquesFromContainer('plaque-entries-container');
            populatePreviewTables(plaques, 'preview');

            document.getElementById('preview-benefactor-list-section').classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
        }
        
        function generateBenefactorPreview() {
            if (!document.getElementById('benefactor-plaque-form').checkValidity()) {
                document.getElementById('benefactor-plaque-form').reportValidity(); return;
            }
            
            const benefactorType = document.querySelector('input[name="benefactor-type"]:checked').value;
            const plaquesInBenefactorForm = collectPlaquesFromContainer('benefactor-plaque-entries-container');
            
            let largeCount = 0;
            let mediumCount = 0;
            let smallCount = 0;

            plaquesInBenefactorForm.forEach(p => {
                if (p.type === '大') largeCount++;
                else if (p.type === '中') mediumCount++;
                else if (p.type === '小') smallCount++;
            });

            if (mediumCount > 0) {
                alert("懺主類型不可包含中牌，請移除。");
                return;
            }

            if (benefactorType === 'two_large') {
                if (largeCount > 2 || smallCount > 6) {
                    alert("此懺主類型最多只能包含 2 支大牌和 6 支小牌，請檢查您的輸入。");
                    return;
                }
            } else { // three_large
                if (largeCount > 3 || smallCount > 6) {
                    alert("此懺主類型最多只能包含 3 支大牌和 6 支小牌，請檢查您的輸入。");
                    return;
                }
            }

            document.getElementById('preview-mode').value = 'benefactor';

            document.getElementById('preview-plaque-name').textContent = document.getElementById('benefactor-plaque-name').value;
            document.getElementById('preview-user-name').textContent = document.getElementById('benefactor-user-name').value;
            document.getElementById('preview-user-phone').textContent = document.getElementById('benefactor-user-phone').value;
            document.getElementById('preview-user-address').textContent = document.getElementById('benefactor-user-address').value;
            document.getElementById('preview-dharma-name').textContent = document.getElementById('benefactor-dharma-name').value;

            const benefactorListSection = document.getElementById('preview-benefactor-list-section');
            const benefactorList = document.getElementById('preview-benefactor-list');
            const benefactorInputs = document.getElementById('benefactor-entries-container').getElementsByTagName('input');
            const names = Array.from(benefactorInputs).map(input => input.value.trim()).filter(name => name);
            
            if(names.length > 0) {
                benefactorList.textContent = names.join(', ');
                benefactorListSection.classList.remove('hidden');
            } else {
                benefactorListSection.classList.add('hidden');
            }
            
            const plaques = collectPlaquesFromContainer('benefactor-plaque-entries-container');
            populatePreviewTables(plaques, 'preview');
            
            benefactorFormSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
        }

        function backToEdit() {
            const mode = document.getElementById('preview-mode').value;
            previewSection.classList.add('hidden');
            if (mode === 'benefactor') {
                benefactorFormSection.classList.remove('hidden');
            } else {
                plaqueFormSection.classList.remove('hidden');
            }
        }

        async function submitData() {
            const mode = document.getElementById('preview-mode').value;
            let data, endpoint, method;

            if (mode === 'benefactor') {
                data = collectBenefactorData();
                const plaqueId = document.getElementById('benefactor-plaque-id').value;
                const isEditing = !!plaqueId;
                method = isEditing ? 'PUT' : 'POST';
                endpoint = isEditing ? `${API_BASE_URL}/plaques/${plaqueId}` : `${API_BASE_URL}/plaques`;
            } else {
                data = collectAndFormatData();
                const plaqueId = document.getElementById('plaque-id').value;
                const isEditing = !!plaqueId;
                method = isEditing ? 'PUT' : 'POST';
                endpoint = isEditing ? `${API_BASE_URL}/plaques/${plaqueId}` : `${API_BASE_URL}/plaques`;
            }
            
            showLoader();
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(endpoint, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(data)
                });
                if (handleUnauthorized(response)) return;
                if (response.ok) {
                    showNotification('牌位資料儲存成功！', 'success');
                    showPlaqueSectionView(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('儲存失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存牌位時發生錯誤:', error);
                showNotification('儲存牌位時發生錯誤。', 'error');
            } finally {
                hideLoader();
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            const token = localStorage.getItem('jwt_token');
            const userId = localStorage.getItem('user_id');
            if (token && userId) {
                showPlaqueSectionView(userId);
            } else {
                showLoginView();
            }
        };

        // --- Dropdown Menu Logic ---
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const dropdownMenu = document.getElementById('dropdown-menu');

        if (menuToggleBtn) {
            menuToggleBtn.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent the window.onclick from closing it immediately
                dropdownMenu.classList.toggle('show');
            });
        }

        // Close the dropdown if the user clicks outside of it
        window.addEventListener('click', (event) => {
            if (dropdownMenu && dropdownMenu.classList.contains('show')) {
                if (!event.target.closest('.header-menu')) {
                     dropdownMenu.classList.remove('show');
                }
            }
        });
    </script>
</body>
</html>
