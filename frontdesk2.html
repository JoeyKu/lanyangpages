<!DOCTYPE html>
<html lang="zh-Hant">
   <head>
      <meta charset="UTF-8" />
      <title>三聯單及佛光卡填單說明</title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.tailwindcss.com"></script>
   </head>
   <body class="bg-gray-100 font-sans text-base sm:text-lg md:text-xl leading-relaxed">
      <!-- 登入頁 -->
      <div id="loginPage" class="min-h-screen flex items-center justify-center px-6 py-8 sm:px-4 sm:py-6 hidden">
         <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-4xl">
            <h2 class="text-lg md:text-4xl lg:text-xl font-bold mb-6 text-center text-indigo-700">請輸入密碼</h2>
            <input type="password" id="passwordInput" class="w-full p-4 border rounded mb-4 text-lg md:text-4xl lg:text-xl" placeholder="輸入密碼">
            <button onclick="submitPassword()" class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 text-lg md:text-4xl lg:text-xl">登入</button>
            <p id="error" class="text-red-600 text-[22px] mt-3 text-center"></p>
         </div>
      </div>
      <!-- 主畫面容器 -->
      <div id="app" class="min-h-screen px-6 py-8 sm:px-4 sm:py-6 hidden"></div>
      <script src="data.js"></script>
      <script>
         const MAX_LOGIN_DURATION = 7 * 24 * 60 * 60 * 1000;
         const MAX_ATTEMPTS = 3;
         const LOCK_DURATION = 5 * 60 * 1000;
         
         let lastUpdate = null;
         
         function checkSessionValid() {
           const isLoggedIn = localStorage.getItem("isLoggedIn") === "yes";
           const loginTime = parseInt(localStorage.getItem("loginTime") || "0");
           const now = Date.now();
         
           if (isLoggedIn && now - loginTime < MAX_LOGIN_DURATION) {
             return true;
           } else {
             return false;
           }
         }
         
         window.addEventListener("DOMContentLoaded", () => {
           const isLoggedIn = localStorage.getItem("isLoggedIn") === "yes";
           const loginTime = parseInt(localStorage.getItem("loginTime") || "0");
           const now = Date.now();
         
           if (isLoggedIn && now - loginTime < MAX_LOGIN_DURATION) {
             loadMainApp();
           } else {
             document.getElementById("loginPage").classList.remove("hidden");
           }
         
           checkLockStatus();
         });
         
         function checkLockStatus() {
           const lockTime = parseInt(localStorage.getItem("lockTime") || "0");
           const now = Date.now();
           const errorDiv = document.getElementById("error");
         
           if (lockTime && now - lockTime < LOCK_DURATION) {
             const remaining = Math.ceil((LOCK_DURATION - (now - lockTime)) / 1000);
             errorDiv.textContent = `密碼已錯誤超過 ${MAX_ATTEMPTS} 次，請 ${remaining} 秒後再試`;
             return true;
           }
         
           if (lockTime && now - lockTime >= LOCK_DURATION) {
             localStorage.removeItem("lockTime");
             localStorage.removeItem("failCount");
           }
         
           return false;
         }
         
         const PASSWORD_HASH = "e73a36f8264731f64049b86564604e671d4bb1cfc0f6ab26803a5ad18040fee2";
         
         async function sha256(text) {
          const encoder = new TextEncoder();
          const data = encoder.encode(text);
          const hashBuffer = await crypto.subtle.digest('SHA-256', data);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
         }
         
         async function submitPassword() {
         if (checkLockStatus()) return;
         
         const pw = document.getElementById("passwordInput").value.trim();
         const hash = await sha256(pw);
         
         if (hash === PASSWORD_HASH) {
         localStorage.setItem("isLoggedIn", "yes");
         localStorage.setItem("loginTime", Date.now().toString());
         localStorage.removeItem("failCount");
         localStorage.removeItem("lockTime");
         loadMainApp();
         } else {
         let count = parseInt(localStorage.getItem("failCount") || "0") + 1;
         localStorage.setItem("failCount", count);
         
         if (count >= MAX_ATTEMPTS) {
         localStorage.setItem("lockTime", Date.now().toString());
         document.getElementById("error").textContent = "錯誤過多，已鎖定 5 分鐘";
         } else {
         document.getElementById("error").textContent = `密碼錯誤，您還有 ${MAX_ATTEMPTS - count} 次機會`;
         }
         }
         }
         
         
         function loadMainApp() {
           document.getElementById("loginPage").classList.add("hidden");
           document.getElementById("app").classList.remove("hidden");
         
           // 更新 app 畫面資料的函式
           function updateApp() {
             if (!checkSessionValid()) {
                 document.getElementById("loginPage").classList.remove("hidden");
                 document.getElementById("app").classList.add("hidden");
                 document.getElementById("passwordInput").value = '';
         
                 return;
             }
             
             const { events, annualEvents, faqs } = frontDeskData;
         
         
         
             app.innerHTML = `
         <div class="max-w-4xl mx-auto">
         <h1 class="text-3xl sm:text-4xl md:text-6xl lg:text-3xl font-bold text-center text-indigo-700">三聯單及佛光卡填單說明</h1>
         <br>
         
         <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700 mb-6 text-center">近期活動</h2>
         <div id="eventBlocks" class="space-y-4 mb-6">
         ${renderEventBlocks(events, 'e')}
         </div>
         
         <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-2 sm:gap-4 mb-6 text-center">
         <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700">例行活動</h2>
         <button onclick="toggleSection('annualEventsBlocks', 'toggleAnnualBtn')" id="toggleAnnualBtn" class="text-indigo-700 underline text-lg md:text-5xl lg:text-xl">
          展開 ▼
         </button>
         </div>
         
         <div id="annualEventsBlocks" class="space-y-4 mb-6 hidden">
         ${renderEventBlocks(annualEvents, 'l')}
         </div>
         
         <div class="flex flex-col sm:flex-row sm:items-center sm:justify-center gap-2 sm:gap-4 mb-6 text-center">
         <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700">常見問答</h2>
         <button onclick="toggleSection('faqSection', 'toggleFaqBtn')" id="toggleFaqBtn" class="text-indigo-700 underline text-lg md:text-5xl lg:text-xl">
          展開 ▼
         </button>
         </div>
         
         <div id="faqSection" class="space-y-4 mb-6 hidden">
         ${renderFaqs(faqs)}
         </div>
         </div>
         `;
           }
         
           /*
           function checkUpdate() {
             google.script.run.withSuccessHandler(function(time) {
               console.log("取得時間：", time);
         
               if (window.lastUpdate && window.lastUpdate !== time) {
                 updateApp(); // 資料有更新，重整
               }
               window.lastUpdate = time;
             }).getLastUpdateTime();
           }
           setInterval(checkUpdate, 60 * 1000); // 每 60 秒檢查一次
         
           // 第一次載入時馬上更新一次
           updateApp();
           */
         }
         
         
         function renderFaqs(faqs) {
           return faqs.map(faq => `
             <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
               <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">
                   ${faq.question}</summary>
               <div class="mt-4 text-gray-700 leading-snug">
                 ${faq.answer
                   .replace(/\n/g, '<br>')
                   .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
                 }
                </div>
             </details>
           `).join('');
         }
         
         function renderEventBlocks(dataArray, blockPrefix) {
           return dataArray.map((e, index) => {
             const warningText = e.warning
               ? `${
                   e.warning
                     .replace(/\n/g, '<br>')
                     .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
                     .replace(/<a\b([^>]*)>/g, '<a style="color: blue; text-decoration: underline;" $1>')
                 }<br>`
               : '';
         
             const formattedDescription = e.description
               .replace(/\n/g, '<br>')
               .replace(/\?([^?]+)\?/g, '<span style="background-color: red; color: white; padding: 2px 4px; border-radius: 4px;">?$1?</span>')
               .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
               .replace(/\[佛光卡\]/g, '<span style="color: green; font-weight: bold;">[佛光卡]</span>')
               .replace(/\[三聯單\]/g, '<span style="color: green; font-weight: bold;">[三聯單]</span>')
               .replace(/\[百萬人興學三聯單\]/g, '<span style="color: green; font-weight: bold;">[百萬人興學三聯單]</span>');
         
             let moreButton = '';
             let detailContent = '';
             if (e.detail) {
               moreButton = `<button onclick="toggleDetails('${blockPrefix}-${index}')" class="text-indigo-600 text-lg md:text-5xl lg:text-xl mt-2">更多</button>`;
               detailContent = `<div id="detail-${blockPrefix}-${index}" class="mt-2 text-gray-500 text-lg md:text-5xl lg:text-xl hidden !leading-relaxed">${e.detail.replace(/\n/g, '<br>')}</div>`;
             }
         
             return `
         <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
         <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">${e.title}</summary>
         
         <div class="text-red-700  mt-4  leading-snug">${warningText}</div>
         
         <div class="mt-4 text-gray-700 leading-snug">${formattedDescription}</div>
         <br>
         ${moreButton}
         ${detailContent}
         </details>
         `;
           }).join('');
         }
         
         function toggleDetails(id) {
           const detailDiv = document.getElementById(`detail-${id}`);
           if (detailDiv) {
             detailDiv.classList.toggle('hidden');
           }
         }
         
         function toggleAnnualEvents() {
         const block = document.getElementById("annualEventsBlocks");
         const button = document.getElementById("toggleAnnualBtn");
         
         const isHidden = block.classList.contains("hidden");
         block.classList.toggle("hidden");
         
         // 顯示不同文字與箭頭
         button.textContent = isHidden ? "收起 ▲" : "展開 ▼";
         }
         
         function toggleSection(sectionId, buttonId) {
         const section = document.getElementById(sectionId);
         const button = document.getElementById(buttonId);
         
         const isHidden = section.classList.contains("hidden");
         section.classList.toggle("hidden");
         
         button.textContent = isHidden ? "收起 ▲" : "展開 ▼";
         }
         
         function logout() {
           localStorage.removeItem("isLoggedIn");
           localStorage.removeItem("loginTime");
           location.reload();
         }
      </script>
   </body>
</html>