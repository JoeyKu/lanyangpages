<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>牌位填單系統</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }
        .container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
        }
        h2, h3 {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="tel"],
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .form-hint {
            color: #d9534f;
            font-style: italic;
            margin-top: 0.25rem;
            font-size: 0.9em;
            display: block;
        }
        .radio-group label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }
        button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }
        button:hover {
            background-color: #0056b3;
        }
        .toggle-link {
            text-align: center;
            margin-top: 1rem;
        }
        .toggle-link a {
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        #plaque-section h3 {
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
            text-align: left;
        }
        #plaque-list {
            list-style: none;
            padding: 0;
        }
        #plaque-list li {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .plaque-name {
            flex-grow: 1;
            word-break: break-all;
        }
        #plaque-list li:hover {
            background-color: #e9ecef;
        }
        .list-item-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .list-item-actions button {
            width: auto;
            margin: 0;
            padding: 4px 8px;
            font-size: 0.8em;
        }
        .copy-plaque-btn {
            background-color: #17a2b8;
        }
        .copy-plaque-btn:hover {
            background-color: #138496;
        }
        .delete-plaque-btn {
            background-color: #dc3545;
        }
        .delete-plaque-btn:hover {
            background-color: #c82333;
        }

        #logout-button {
            background-color: #6c757d;
        }
        #logout-button:hover {
            background-color: #5a6268;
        }
        .plaque-entry {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1.5rem;
            margin-top: 1rem;
            position: relative;
        }
        .plaque-entry-header {
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        .remove-plaque-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1rem;
            line-height: 30px;
            text-align: center;
            padding: 0;
        }
        #add-plaque-btn {
            background-color: #28a745;
            margin-top: 1rem;
        }
        #add-plaque-btn:hover {
            background-color: #218838;
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        #cancel-plaque-form, #back-to-edit-btn {
            background-color: #6c757d;
        }
        #cancel-plaque-form:hover, #back-to-edit-btn:hover {
            background-color: #5a6268;
        }

        /* 預覽畫面樣式 */
        #preview-section {
            border: 1px solid #ccc;
            padding: 1.5rem;
            border-radius: 8px;
            background-color: #fafafa;
        }
        #preview-section h3, #preview-section h4 {
            text-align: left;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        .preview-item {
            display: flex;
            margin-bottom: 0.5rem;
            align-items: flex-start;
        }
        .preview-item-label {
            font-weight: bold;
            width: 130px;
            color: #555;
            flex-shrink: 0;
        }
        
        /* 通知橫幅樣式 */
        #notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            text-align: center;
            color: white;
            z-index: 1000;
            box-sizing: border-box;
            transform: translateY(-100%);
            transition: transform 0.4s ease-in-out;
        }
        #notification-banner.show {
            transform: translateY(0);
        }
        #notification-banner.success {
            background-color: #28a745;
        }
        #notification-banner.error {
            background-color: #dc3545;
        }
        #notification-close {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 0.5rem;
            margin: 0;
            width: auto;
        }

        /* 預覽表格樣式 */
        .preview-table-section {
            margin-top: 2rem;
        }
        .preview-table-section table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .preview-table-section th,
        .preview-table-section td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            word-break: break-word;
        }
        .preview-table-section th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
    </style>
</head>
<body>
    
    <div id="notification-banner">
        <span id="notification-message"></span>
        <button id="notification-close">&times;</button>
    </div>

    <div class="container">
        <!-- Login Form -->
        <div id="login-form">
            <h2>登入</h2>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label for="login-user-id">使用者帳號</label>
                    <input type="text" id="login-user-id" required>
                </div>
                <div class="form-group">
                    <label for="login-password">密碼</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">登入</button>
            </form>
            <div class="toggle-link">
                <a onclick="toggleForms()">還沒有帳號？建立一個</a>
            </div>
        </div>

        <!-- Create Account Form -->
        <div id="create-account-form" class="hidden">
            <h2>建立帳號</h2>
            <form onsubmit="createAccount(event)">
                <div class="form-group">
                    <label for="create-user-id">新使用者帳號</label>
                    <input type="text" id="create-user-id" required>
                </div>
                <div class="form-group">
                    <label for="create-password">密碼</label>
                    <input type="password" id="create-password" required>
                </div>
                <button type="submit">建立</button>
            </form>
            <div class="toggle-link">
                <a onclick="toggleForms()">已經有帳號了？登入</a>
            </div>
        </div>

        <!-- Plaque Main Section -->
        <div id="plaque-section" class="hidden">
            <h2>牌位資訊</h2>
            <button onclick="showPlaqueForm()">新增牌位資訊(大中小牌)</button>
            <button>新增牌位資訊(懺主)</button>
            
            <!-- 新增: 搜尋框 -->
            <div class="form-group" style="margin-top: 2rem;">
                <label for="search-input">搜尋牌位名稱</label>
                <input type="text" id="search-input" onkeyup="filterPlaqueList()" placeholder="請輸入關鍵字...">
            </div>

            <h3>超薦牌位清單:</h3>
            <ul id="plaque-list"></ul>

            <button id="logout-button" onclick="logout()">登出</button>
        </div>
        
        <!-- Add/Edit Plaque Form Section -->
        <div id="plaque-form-section" class="hidden">
            <h3 id="form-title">法會超薦資料</h3>
            <form id="main-plaque-form">
                <input type="hidden" id="plaque-id">
                <div class="form-group">
                    <label for="plaque-name">名稱</label>
                    <input type="text" id="plaque-name" placeholder="例如: 地藏法會超薦資料" required>
                </div>
                
                <fieldset>
                    <legend><strong>基本資料</strong></legend>
                    <div class="form-group">
                        <label for="user_name">姓名</label>
                        <input type="text" id="user_name" required>
                    </div>
                    <div class="form-group">
                        <label for="user_phone">電話</label>
                        <input type="tel" id="user_phone" required>
                    </div>
                    <div class="form-group">
                        <label for="user_address">地址</label>
                        <input type="text" id="user_address" required>
                    </div>
                </fieldset>

                <fieldset>
                    <legend><strong>牌位資訊</strong></legend>
                    <div id="plaque-entries-container"></div>
                    <button type="button" id="add-plaque-btn" onclick="addPlaqueEntry()">新增一筆牌位</button>
                </fieldset>

                <div class="form-actions">
                    <button type="button" onclick="generatePreview()">預覽資料</button>
                    <button type="button" id="cancel-plaque-form" onclick="hidePlaqueForm()">取消</button>
                </div>
            </form>
        </div>

        <!-- Preview Section -->
        <div id="preview-section" class="hidden">
            <h3>資料預覽</h3>
            
            <h4>基本資料</h4>
            <div class="preview-item">
                <div class="preview-item-label">名稱:</div>
                <div id="preview-plaque-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">姓名:</div>
                <div id="preview-user-name"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">電話:</div>
                <div id="preview-user-phone"></div>
            </div>
            <div class="preview-item">
                <div class="preview-item-label">地址:</div>
                <div id="preview-user-address"></div>
            </div>
            
            <div id="preview-big-section" class="preview-table-section">
                <h4>您的大牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-big-tbody"></tbody>
                </table>
            </div>
            <div id="preview-medium-section" class="preview-table-section">
                <h4>您的中牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-medium-tbody"></tbody>
                </table>
            </div>
            <div id="preview-small-section" class="preview-table-section">
                <h4>您的小牌資訊:</h4>
                <table>
                    <thead><tr><th>稱謂</th><th>亡者/項目/地址</th><th>陽上</th></tr></thead>
                    <tbody id="preview-small-tbody"></tbody>
                </table>
            </div>

            <div class="form-actions">
                <button type="button" onclick="submitData()">確認儲存</button>
                <button type="button" id="back-to-edit-btn" onclick="backToEdit()">返回修改</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:3000';

        // --- DOM Elements ---
        const loginForm = document.getElementById('login-form');
        const createAccountForm = document.getElementById('create-account-form');
        const plaqueSection = document.getElementById('plaque-section');
        const plaqueFormSection = document.getElementById('plaque-form-section');
        const previewSection = document.getElementById('preview-section');
        const plaqueList = document.getElementById('plaque-list');
        const plaqueEntriesContainer = document.getElementById('plaque-entries-container');
        let plaqueEntryCounter = 0;
        
        const notificationBanner = document.getElementById('notification-banner');
        const notificationMessage = document.getElementById('notification-message');
        const notificationClose = document.getElementById('notification-close');
        let notificationTimeout;

        // --- Notification Banner ---
        function showNotification(message, type = 'success') {
            clearTimeout(notificationTimeout); 

            notificationMessage.textContent = message;
            notificationBanner.className = ''; 
            notificationBanner.classList.add(type, 'show');

            notificationTimeout = setTimeout(() => {
                notificationBanner.classList.remove('show');
            }, 4000);
        }

        notificationClose.addEventListener('click', () => {
            clearTimeout(notificationTimeout);
            notificationBanner.classList.remove('show');
        });


        // --- Authentication & View Management ---

        function showLoginView() {
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('user_id');
            document.getElementById('login-user-id').value = '';
            document.getElementById('login-password').value = '';
            
            plaqueSection.classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            loginForm.classList.remove('hidden');
            createAccountForm.classList.add('hidden');
            plaqueList.innerHTML = '';
        }
        
        function handleUnauthorized(response) {
            if (response.status === 401) {
                showLoginView();
                showNotification('登入已過期，請重新登入。', 'error');
                return true;
            }
            return false;
        }

        function toggleForms() {
            loginForm.classList.toggle('hidden');
            createAccountForm.classList.toggle('hidden');
        }

        async function login(event) {
            event.preventDefault();
            const userId = document.getElementById('login-user-id').value;
            const password = document.getElementById('login-password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password }),
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('jwt_token', data.token);
                    localStorage.setItem('user_id', userId);
                    showPlaqueSectionView(userId);
                } else {
                    showNotification('登入失敗: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('登入時發生錯誤:', error);
                showNotification('登入時發生錯誤，請查看主控台。', 'error');
            }
        }

        async function createAccount(event) {
            event.preventDefault();
            const userId = document.getElementById('create-user-id').value;
            const password = document.getElementById('create-password').value;
            try {
                const response = await fetch(`${API_BASE_URL}/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, password: password }),
                });
                const data = await response.json();
                if (response.ok) {
                    showNotification('帳號建立成功！請登入。', 'success');
                    toggleForms();
                } else {
                    showNotification('建立帳號失敗: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('建立帳號時發生錯誤:', error);
                showNotification('建立帳號時發生錯誤，請查看主控台。', 'error');
            }
        }
        
        async function fetchPlaques(userId) {
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques?user_id=${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    const data = await response.json();
                    plaqueList.innerHTML = '';
                    if (data.plaques && data.plaques.length > 0) {
                        data.plaques.forEach(plaque => {
                            const li = document.createElement('li');
                            li.onclick = () => editPlaque(plaque.timestamp);

                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'plaque-name';
                            nameSpan.textContent = plaque.plaque_name;

                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'list-item-actions';

                            const copyBtn = document.createElement('button');
                            copyBtn.textContent = '複製';
                            copyBtn.className = 'copy-plaque-btn';
                            copyBtn.onclick = (event) => {
                                event.stopPropagation();
                                copyPlaque(plaque.timestamp, plaque.plaque_name);
                            };

                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = '刪除';
                            deleteBtn.className = 'delete-plaque-btn';
                            deleteBtn.onclick = (event) => {
                                event.stopPropagation();
                                deletePlaque(plaque.timestamp, plaque.plaque_name);
                            };
                            
                            actionsDiv.appendChild(copyBtn);
                            actionsDiv.appendChild(deleteBtn);
                            
                            li.appendChild(nameSpan);
                            li.appendChild(actionsDiv);
                            
                            plaqueList.appendChild(li);
                        });
                    } else {
                        plaqueList.innerHTML = '<li>尚無牌位資料</li>';
                    }
                } else {
                    console.error('獲取牌位資料失敗:', await response.text());
                }
            } catch (error) {
                console.error('獲取牌位資料時發生錯誤:', error);
            }
        }
        
        // 新增: 搜尋功能函式
        function filterPlaqueList() {
            const input = document.getElementById('search-input');
            const filter = input.value.toLowerCase();
            const ul = document.getElementById('plaque-list');
            const liItems = ul.getElementsByTagName('li');

            for (let i = 0; i < liItems.length; i++) {
                const nameSpan = liItems[i].querySelector('.plaque-name');
                if (nameSpan) { // 確保不是 "尚無資料" 的 li
                    const txtValue = nameSpan.textContent || nameSpan.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        liItems[i].style.display = "";
                    } else {
                        liItems[i].style.display = "none";
                    }
                }
            }
        }

        function showPlaqueSectionView(userId) {
            loginForm.classList.add('hidden');
            createAccountForm.classList.add('hidden');
            plaqueFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
            document.getElementById('search-input').value = ''; // 清空搜尋框
            fetchPlaques(userId);
        }
        
        function logout() {
            showLoginView();
            showNotification('您已登出。', 'success');
        }
        
        // --- Form Handling ---

        function showPlaqueForm() {
            plaqueSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            plaqueFormSection.classList.remove('hidden');
            
            document.getElementById("main-plaque-form").reset();
            document.getElementById('plaque-id').value = '';
            document.getElementById('form-title').textContent = "新增法會超薦資料";

            plaqueEntriesContainer.innerHTML = '';
            plaqueEntryCounter = 0;
            addPlaqueEntry();
        }

        function hidePlaqueForm() {
            plaqueFormSection.classList.add('hidden');
            previewSection.classList.add('hidden');
            plaqueSection.classList.remove('hidden');
            document.getElementById('plaque-id').value = '';
        }

        // --- Edit, Delete, Copy Logic ---

        async function editPlaque(id) {
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取資料失敗');
                
                const data = await response.json();
                populateFormWithData(data);

            } catch(error) {
                showNotification(error.message, 'error');
                console.error("編輯時發生錯誤:", error);
            }
        }
        
        async function deletePlaque(id, name) {
            if (!confirm(`您確定要刪除 "${name}" 嗎？此操作無法復原。`)) {
                return;
            }

            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    showNotification('牌位資料刪除成功！', 'success');
                    fetchPlaques(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('刪除失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('刪除時發生錯誤:', error);
                showNotification('刪除時發生錯誤，請查看主控台。', 'error');
            }
        }
        
        async function copyPlaque(id, name) {
            if (!confirm(`您確定要複製 "${name}" 嗎？`)) {
                return;
            }
            try {
                const token = localStorage.getItem('jwt_token');
                let response = await fetch(`${API_BASE_URL}/plaques/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (handleUnauthorized(response)) return;
                if (!response.ok) throw new Error('獲取複製資料失敗');
                
                const dataToCopy = await response.json();
                
                dataToCopy.plaque_name = `${dataToCopy.plaque_name} - 複製`;
                delete dataToCopy.timestamp;

                response = await fetch(`${API_BASE_URL}/plaques`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(dataToCopy)
                });

                if (handleUnauthorized(response)) return;
                
                if (response.ok) {
                    showNotification('牌位資料複製成功！', 'success');
                    fetchPlaques(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('複製失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }

            } catch (error) {
                showNotification(error.message, 'error');
                console.error("複製時發生錯誤:", error);
            }
        }

        function populateFormWithData(data) {
            showPlaqueForm();
            document.getElementById('form-title').textContent = "修改法會超薦資料";
            document.getElementById('plaque-id').value = data.timestamp;
            
            document.getElementById('plaque-name').value = data.plaque_name || '';
            document.getElementById('user_name').value = data.user_name || '';
            document.getElementById('user_phone').value = data.user_phone || '';
            document.getElementById('user_address').value = data.user_address || '';

            plaqueEntriesContainer.innerHTML = '';
            plaqueEntryCounter = 0;

            if (data.plaque_data && data.plaque_data.length > 0) {
                data.plaque_data.forEach(item => {
                    addPlaqueEntry();
                    const entryId = plaqueEntryCounter;
                    
                    document.querySelector(`input[name="type-${entryId}"][value="${item.type}"]`).checked = true;
                    
                    const titleSelect = document.getElementById(`title-${entryId}`);
                    const isStandardTitle = Array.from(titleSelect.options).some(opt => opt.value === item.item_title);

                    if (isStandardTitle) {
                        titleSelect.value = item.item_title;
                    } else {
                        titleSelect.value = 'other';
                    }
                    
                    handleTitleChange(titleSelect, entryId);

                    if (!isStandardTitle) {
                        const otherInput = document.getElementById(`title-other-${entryId}`);
                        if (otherInput) otherInput.value = item.item_title;
                    }
                    
                    document.getElementById(`deceased-${entryId}`).value = item.item_name;
                    document.getElementById(`sponsor-${entryId}`).value = item.item_benefactor;
                });
            } else {
                addPlaqueEntry();
            }

            plaqueSection.classList.add('hidden');
            plaqueFormSection.classList.remove('hidden');
        }


        // --- Dynamic Form Entry ---

        function handleTitleChange(selectElement, entryId) {
            const selectedValue = selectElement.value;
            const deceasedInput = document.getElementById(`deceased-${entryId}`);
            const hintElement = document.getElementById(`hint-${entryId}`);
            
            const existingOtherInput = document.getElementById(`title-other-${entryId}`);
            if (existingOtherInput) existingOtherInput.remove();

            deceasedInput.disabled = false;
            deceasedInput.value = '';
            hintElement.textContent = '';
            deceasedInput.placeholder = '';

            switch (selectedValue) {
                case 'ancestors':
                    hintElement.textContent = '請於下方欄位填寫「姓氏」';
                    break;
                case 'foundation':
                    hintElement.textContent = '請於下方欄位填寫「地址」';
                    break;
                case 'unborn_children':
                case 'karmic_creditors':
                case 'ten_directions':
                    hintElement.textContent = '（此項無需填寫）';
                    deceasedInput.value = 'None';
                    deceasedInput.disabled = true;
                    break;
                case 'father':
                case 'mother':
                case 'grandfather':
                case 'grandmother':
                    hintElement.textContent = '請於下方欄位填寫「姓名」';
                    break;
                case 'brother':
                case 'younger_brother':
                case 'sister':
                case 'younger_sister':
                case 'son':
                case 'daughter':
                    hintElement.textContent = '請於下方欄位填寫「姓名」並註明是否已婚';
                    break;
                case 'other':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.placeholder = '請註明稱謂';
                    input.id = `title-other-${entryId}`;
                    input.className = 'title-other-input';
                    input.style.marginTop = '0.5rem';
                    selectElement.parentNode.appendChild(input);
                    hintElement.textContent = '若是個人(如朋友)，請註明「性別」及是否已婚';
                    break;
            }
        }

        function addPlaqueEntry() {
            plaqueEntryCounter++;
            const entryId = plaqueEntryCounter;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'plaque-entry';
            entryDiv.id = `plaque-entry-${entryId}`;
            entryDiv.innerHTML = `
                <div class="plaque-entry-header">牌位 #${entryId}</div>
                ${plaqueEntriesContainer.children.length > 0 ? `<button type="button" class="remove-plaque-btn" onclick="removePlaqueEntry(${entryId})">X</button>` : ''}
                <div class="form-group">
                    <label>型別</label>
                    <div class="radio-group">
                        <label><input type="radio" name="type-${entryId}" value="小" checked> 小牌</label>
                        <label><input type="radio" name="type-${entryId}" value="中"> 中牌</label>
                        <label><input type="radio" name="type-${entryId}" value="大"> 大牌</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="title-${entryId}">稱謂</label>
                    <select id="title-${entryId}" onchange="handleTitleChange(this, ${entryId})">
                        <option value="ancestors">歷代祖先</option>
                        <option value="karmic_creditors">累劫冤親債主</option>
                        <option value="foundation">地基主</option>
                        <option value="ten_directions">十方法界一切眾生</option>
                        <option value="unborn_children">未出世子女</option>
                        <option value="father">父</option>
                        <option value="mother">母</option>
                        <option value="brother">兄</option>
                        <option value="younger_brother">弟</option>
                        <option value="sister">姊</option>
                        <option value="younger_sister">妹</option>
                        <option value="grandfather">祖父</option>
                        <option value="grandmother">祖母</option>
                        <option value="son">子</option>
                        <option value="daughter">女</option>
                        <option value="other">其它(需註明)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="deceased-${entryId}">亡者/項目/地址</label>
                    <small id="hint-${entryId}" class="form-hint"></small>
                    <input type="text" id="deceased-${entryId}" required>
                </div>
                <div class="form-group">
                    <label for="sponsor-${entryId}">陽上</label>
                    <input type="text" id="sponsor-${entryId}" required>
                </div>
            `;
            plaqueEntriesContainer.appendChild(entryDiv);
            const newSelect = document.getElementById(`title-${entryId}`);
            handleTitleChange(newSelect, entryId);
        }
        
        function removePlaqueEntry(entryId) {
            document.getElementById(`plaque-entry-${entryId}`)?.remove();
        }

        // --- Data Collection, Preview, and Submission ---

        function collectAndFormatData() {
            const plaqueData = [];
            const entries = plaqueEntriesContainer.getElementsByClassName('plaque-entry');
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const entryId = entry.id.split('-')[2];
                
                let apiTitle = entry.querySelector(`#title-${entryId}`).value;
                if (apiTitle === 'other') {
                    const otherInput = entry.querySelector(`#title-other-${entryId}`);
                    apiTitle = otherInput ? otherInput.value.trim() : 'other';
                }

                plaqueData.push({
                    type: entry.querySelector(`input[name="type-${entryId}"]:checked`).value,
                    item_title: apiTitle,
                    item_name: entry.querySelector(`#deceased-${entryId}`).value,
                    item_benefactor: entry.querySelector(`#sponsor-${entryId}`).value,
                });
            }
            return {
                user_id: localStorage.getItem('user_id'),
                plaque_name: document.getElementById('plaque-name').value,
                user_name: document.getElementById('user_name').value,
                user_phone: document.getElementById('user_phone').value,
                user_address: document.getElementById('user_address').value,
                plaque_data: plaqueData
            };
        }

        function generatePreview() {
            if (!document.getElementById('main-plaque-form').checkValidity()) {
                document.getElementById('main-plaque-form').reportValidity();
                return;
            }
            
            document.getElementById('preview-plaque-name').textContent = document.getElementById('plaque-name').value;
            document.getElementById('preview-user-name').textContent = document.getElementById('user_name').value;
            document.getElementById('preview-user-phone').textContent = document.getElementById('user_phone').value;
            document.getElementById('preview-user-address').textContent = document.getElementById('user_address').value;

            const previewBigTableBody = document.getElementById('preview-big-tbody');
            const previewMediumTableBody = document.getElementById('preview-medium-tbody');
            const previewSmallTableBody = document.getElementById('preview-small-tbody');
            
            const previewBigSection = document.getElementById('preview-big-section');
            const previewMediumSection = document.getElementById('preview-medium-section');
            const previewSmallSection = document.getElementById('preview-small-section');

            previewBigTableBody.innerHTML = '';
            previewMediumTableBody.innerHTML = '';
            previewSmallTableBody.innerHTML = '';

            const entries = plaqueEntriesContainer.getElementsByClassName('plaque-entry');
            let bigCount = 0, mediumCount = 0, smallCount = 0;

            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const entryId = entry.id.split('-')[2];
                
                const type = entry.querySelector(`input[name="type-${entryId}"]:checked`).value;
                const titleSelect = entry.querySelector(`#title-${entryId}`);
                let previewTitleText = titleSelect.options[titleSelect.selectedIndex].text;
                if (titleSelect.value === 'other') {
                    const otherInput = entry.querySelector(`#title-other-${entryId}`);
                    previewTitleText = otherInput ? otherInput.value.trim() : '其它(需註明)';
                }
                const deceased = entry.querySelector(`#deceased-${entryId}`).value;
                const sponsor = entry.querySelector(`#sponsor-${entryId}`).value;

                const row = document.createElement('tr');
                row.innerHTML = `<td>${previewTitleText}</td><td>${deceased}</td><td>${sponsor}</td>`;

                if (type === '大') {
                    previewBigTableBody.appendChild(row);
                    bigCount++;
                } else if (type === '中') {
                    previewMediumTableBody.appendChild(row);
                    mediumCount++;
                } else {
                    previewSmallTableBody.appendChild(row);
                    smallCount++;
                }
            }

            previewBigSection.style.display = bigCount > 0 ? 'block' : 'none';
            previewMediumSection.style.display = mediumCount > 0 ? 'block' : 'none';
            previewSmallSection.style.display = smallCount > 0 ? 'block' : 'none';

            plaqueFormSection.classList.add('hidden');
            previewSection.classList.remove('hidden');
        }

        function backToEdit() {
            previewSection.classList.add('hidden');
            plaqueFormSection.classList.remove('hidden');
        }

        async function submitData() {
            const data = collectAndFormatData();
            const plaqueId = document.getElementById('plaque-id').value;
            const isEditing = !!plaqueId;

            const method = isEditing ? 'PUT' : 'POST';
            const endpoint = isEditing ? `${API_BASE_URL}/plaques/${plaqueId}` : `${API_BASE_URL}/plaques`;
            
            try {
                const token = localStorage.getItem('jwt_token');
                const response = await fetch(endpoint, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                if (handleUnauthorized(response)) return;
                if (response.ok) {
                    showNotification('牌位資料儲存成功！', 'success');
                    showPlaqueSectionView(localStorage.getItem('user_id'));
                } else {
                    const errorData = await response.json();
                    showNotification('儲存失敗: ' + (errorData.message || '未知錯誤'), 'error');
                }
            } catch (error) {
                console.error('儲存牌位時發生錯誤:', error);
                showNotification('儲存牌位時發生錯誤。', 'error');
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            const token = localStorage.getItem('jwt_token');
            const userId = localStorage.getItem('user_id');
            if (token && userId) {
                showPlaqueSectionView(userId);
            }
        };
    </script>
</body>
</html>