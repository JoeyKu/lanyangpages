<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>ä¸‰è¯å–®åŠä½›å…‰å¡å¡«å–®èªªæ˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ä¸€éµæ”¾å¤§ï¼šåˆ‡åˆ° html.text-zoom æ™‚ï¼Œæ•´ç«™å­—ç´šæŒ‰ rem ç­‰æ¯”ä¾‹æ”¾å¤§ */
    html.text-zoom {
      font-size: 150%;
    }

    /* æƒ³æ›´å¤§å¯æ”¹ 125% */

    /* è®“ã€Œä¾‹è¡Œæ´»å‹• / å¸¸è¦‹å•ç­”ã€é€™å…©çµ„æ¨™é¡Œåˆ—ä¸­çš„ h2 èˆ‡æŒ‰éˆ•å­—ç´š 100% åŒæ­¥ */
    .section-row h2,
    .section-row button {
      font-size: inherit !important;
      line-height: 1.25;
    }
  </style>
</head>

<body class="bg-gray-100 font-sans text-base sm:text-lg md:text-xl leading-relaxed">
  <!-- ç™»å…¥é  -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center px-6 py-8 sm:px-4 sm:py-6 hidden">
    <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-4xl">
      <h2 class="text-lg md:text-4xl lg:text-xl font-bold mb-6 text-center text-indigo-700">è«‹è¼¸å…¥å¯†ç¢¼</h2>
      <input type="password" id="passwordInput" class="w-full p-4 border rounded mb-4 text-lg md:text-4xl lg:text-xl"
        placeholder="è¼¸å…¥å¯†ç¢¼" />
      <button onclick="submitPassword()"
        class="w-full bg-indigo-600 text-white py-3 rounded hover:bg-indigo-700 text-lg md:text-4xl lg:text-xl">ç™»å…¥</button>
      <p id="error" class="text-red-600 text-[22px] mt-3 text-center"></p>
    </div>
  </div>

  <!-- ä¸»ç•«é¢å®¹å™¨ -->
  <div id="app" class="min-h-screen px-6 py-8 sm:px-4 sm:py-6 hidden"></div>

  <!-- å·¥å…·åˆ—ï¼ˆç™»å…¥å¾Œé¡¯ç¤ºï¼‰ï¼šæ”¾å¤§å­—é«” / ç™»å‡º -->
  <div id="toolbar"
    class="w-full sticky bottom-0 left-0 bg-white/90 backdrop-blur p-3 shadow flex gap-3 justify-center hidden">
    <button id="zoomBtn" onclick="toggleFontSize()"
      class="px-4 py-3 rounded bg-green-600 text-white hover:bg-green-700 text-base md:text-lg">
      æ”¾å¤§å­—é«”
    </button>
    <button onclick="logout()"
      class="px-4 py-3 rounded bg-indigo-600 text-white hover:bg-indigo-700 text-base md:text-lg">
      ç™»å‡º
    </button>
  </div>

  <script>
    window.addEventListener("DOMContentLoaded", () => {
      // å¥—ç”¨å­—é«”æ”¾å¤§åå¥½ï¼ˆç™»å…¥å‰å¾Œéƒ½ç”Ÿæ•ˆï¼‰
      applyZoomFromStorage();

      document.getElementById("loginPage").classList.remove("hidden");

      const isLoggedIn = localStorage.getItem("isLoggedIn") === "yes";

      if (isLoggedIn) {
        loadMainApp();
      } else {
        document.getElementById("loginPage").classList.remove("hidden");
      }
    });

    async function submitPassword() {
      const pw = document.getElementById("passwordInput").value.trim();
      const errorDiv = document.getElementById("error");
      //const loginUrl = "https://36abxtve73lsev23b5bs3264iq0ksxal.lambda-url.us-east-1.on.aws/login";
      const loginUrl = "https://yucq6ksf6ba3de2zsayin5s5wi0yekag.lambda-url.us-east-1.on.aws/login";

      try {
        const response = await fetch(loginUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ pass: pw }),
        });

        const result = await response.json();

        if (response.ok && result.token) {
          localStorage.setItem("isLoggedIn", "yes");
          localStorage.setItem("token", result.token);
          loadMainApp();
        } else {
          errorDiv.textContent = result?.message || "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
        }
      } catch (error) {
        console.error("Login request failed:", error);
        errorDiv.textContent = "ç™»å…¥è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚";
      }
    }

    function loadMainApp() {
      document.getElementById("loginPage").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      document.getElementById("toolbar").classList.remove("hidden"); // é¡¯ç¤ºå·¥å…·åˆ—
      applyZoomFromStorage(); // è®“æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºæ­£ç¢ºï¼ˆæ”¾å¤§/é‚„åŸï¼‰

      updateApp(); // ç¬¬ä¸€æ¬¡è¼‰å…¥æ™‚é¦¬ä¸Šæ›´æ–°ä¸€æ¬¡
    }

    async function updateApp() {
      //const getInfoUrl = "https://36abxtve73lsev23b5bs3264iq0ksxal.lambda-url.us-east-1.on.aws/getinfo";
      const getInfoUrl = "https://yucq6ksf6ba3de2zsayin5s5wi0yekag.lambda-url.us-east-1.on.aws/getinfo";

      try {
        const token = localStorage.getItem("token");
        if (!token) return logout();

        const response = await fetch(getInfoUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
        });

        if (!response.ok) return logout();

        const data = await response.json();
        const { events, annualEvents, faqs } = data;
        const app = document.getElementById("app");

        app.innerHTML = `
            <div class="max-w-4xl mx-auto">
              <h1 class="text-3xl sm:text-4xl md:text-6xl lg:text-3xl font-bold text-center text-indigo-700">
                ä¸‰è¯å–®åŠä½›å…‰å¡å¡«å–®èªªæ˜
              </h1>
              <br>

              <!-- è¿‘æœŸæ´»å‹• -->
              <h2 class="text-2xl sm:text-3xl md:text-5xl lg:text-2xl font-bold text-indigo-700 mb-6 text-center">
                è¿‘æœŸæ´»å‹•
              </h2>
              <div id="eventBlocks" class="space-y-4 mb-6">
                ${renderEventBlocks(events, "e")}
              </div>

              <!-- ä¾‹è¡Œæ´»å‹•ï¼ˆæ¨™é¡Œèˆ‡æŒ‰éˆ•åŒç´šï¼‰ -->
              <div class="section-row text-indigo-700 text-center
                          flex flex-col sm:flex-row sm:items-center sm:justify-center
                          gap-2 sm:gap-4 mb-6
                          text-xl sm:text-2xl md:text-3xl lg:text-2xl">
                <h2 class="font-bold">ä¾‹è¡Œæ´»å‹•</h2>
                <button
                  id="toggleAnnualBtn"
                  class="underline"
                  onclick="toggleSection('annualEventsBlocks', 'toggleAnnualBtn')"
                >å±•é–‹ â–¼</button>
              </div>

              <div id="annualEventsBlocks" class="space-y-4 mb-6 hidden">
                ${renderEventBlocks(annualEvents, "l")}
              </div>

              <!-- å¸¸è¦‹å•ç­”ï¼ˆæ¨™é¡Œèˆ‡æŒ‰éˆ•åŒç´šï¼‰ -->
              <div class="section-row text-indigo-700 text-center
                          flex flex-col sm:flex-row sm:items-center sm:justify-center
                          gap-2 sm:gap-4 mb-6
                          text-xl sm:text-2xl md:text-3xl lg:text-2xl">
                <h2 class="font-bold">å¸¸è¦‹å•ç­”</h2>
                <button
                  id="toggleFaqBtn"
                  class="underline"
                  onclick="toggleSection('faqSection', 'toggleFaqBtn')"
                >å±•é–‹ â–¼</button>
              </div>

              <div id="faqSection" class="space-y-4 mb-6 hidden">
                ${renderFaqs(faqs)}
              </div>
            </div>
          `;
      } catch (error) {
        console.error("Failed to fetch app data:", error);
        logout();
      }
    }

    function formatText(text) {
      if (!text) return "";
      return text
        .replace(/<span style="color: green;">(.*?)<\/span>/g, '$1') // Strip legacy green spans
        .replace(/^[ \t]*-{2,}\s*(.*)$/gm, '<div style="margin-left: 1.5rem; display: flex; align-items: flex-start; gap: 0.5rem; color: #4b5563;"><span style="flex-shrink: 0;">â†³</span><span>$1</span></div>')
        .replace(/^[ \t]*-\s*(.*)$/gm, '<div style="display: flex; align-items: flex-start; gap: 0.5rem; font-weight: 500;"><span style="flex-shrink: 0; color: #b45309;">ğŸ”¸</span><span>$1</span></div>')
        .replace(/\n/g, "<br>")
        .replace(/<br><div/g, "<div")
        .replace(/<\/div><br>/g, "</div>")
        .replace(/\?([^?]+)\?/g, '<span style="background-color: red; color: white; padding: 2px 4px; border-radius: 4px;">?$1?</span>')
        .replace(/\*([^*]+)\*/g, '<span style="background-color: yellow; color: black; padding: 2px 4px; border-radius: 4px;">$1</span>')
        .replace(/\[æ³¨æ„äº‹é …\]/g, '<span style="background-color: #b91c1c; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; margin-right: 4px; display: inline-block;">æ³¨æ„äº‹é …</span>')
        .replace(/\[ä½›å…‰å¡\]/g, '<span style="background-color: #2d5a27; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; margin-right: 4px; display: inline-block;">ä½›å…‰å¡</span>')
        .replace(/\[ä¸‰è¯å–®\]/g, '<span style="background-color: #2d5a27; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; margin-right: 4px; display: inline-block;">ä¸‰è¯å–®</span>')
        .replace(/\[ç™¾è¬äººèˆˆå­¸ä¸‰è¯å–®\]/g, '<span style="background-color: #2d5a27; color: white; padding: 2px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9em; margin-right: 4px; display: inline-block;">ç™¾è¬äººèˆˆå­¸ä¸‰è¯å–®</span>');
    }

    function renderFaqs(faqs) {
      return faqs
        .map(
          (faq) => `
              <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
                <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">
                  ${faq.question}</summary>
                <div class="mt-4 text-gray-700 leading-snug">
                  ${formatText(faq.answer)}
                </div>
              </details>
            `
        )
        .join("");
    }

    function renderEventBlocks(dataArray, blockPrefix) {
      return dataArray
        .map((e, index) => {
          const warningText = e.warning
            ? `<div class="text-red-700 mt-4 leading-snug">${formatText(e.warning).replace(/<a\b([^>]*)>/g, '<a style="color: blue; text-decoration: underline;" $1>')}</div>`
            : "";

          const formattedDescription = formatText(e.description);

          let moreButton = "";
          let detailContent = "";
          if (e.detail) {
            moreButton = `<button onclick="toggleDetails('${blockPrefix}-${index}')" class="text-indigo-600 text-lg md:text-5xl lg:text-xl mt-2">æ›´å¤š</button>`;
            detailContent = `<div id="detail-${blockPrefix}-${index}" class="mt-2 text-gray-500 text-lg md:text-5xl lg:text-xl hidden !leading-relaxed">${e.detail.replace(/\n/g, "<br>")}</div>`;
          }

          return `
              <details class="bg-white rounded shadow p-4 text-lg md:text-5xl lg:text-xl leading-relaxed">
                <summary class="text-lg md:text-5xl lg:text-xl cursor-pointer text-indigo-700 font-semibold">${e.title}</summary>

                <div class="text-red-700 mt-4 leading-snug">${warningText}</div>

                <div class="mt-4 text-gray-700 leading-snug">${formattedDescription}</div>
                <br>
                ${moreButton}
                ${detailContent}
              </details>
            `;
        })
        .join("");
    }

    function toggleDetails(id) {
      const detailDiv = document.getElementById(`detail-${id}`);
      if (detailDiv) {
        detailDiv.classList.toggle("hidden");
      }
    }

    function toggleSection(sectionId, buttonId) {
      const section = document.getElementById(sectionId);
      const button = document.getElementById(buttonId);

      const isHidden = section.classList.contains("hidden");
      section.classList.toggle("hidden");

      button.textContent = isHidden ? "æ”¶èµ· â–²" : "å±•é–‹ â–¼";
    }

    function toggleFontSize() {
      const root = document.documentElement;
      const turnedOn = root.classList.toggle("text-zoom");
      localStorage.setItem("textZoom", turnedOn ? "on" : "off");

      const btn = document.getElementById("zoomBtn");
      if (btn) btn.textContent = turnedOn ? "é‚„åŸå­—é«”" : "æ”¾å¤§å­—é«”";
    }

    function applyZoomFromStorage() {
      const turnedOn = localStorage.getItem("textZoom") === "on";
      document.documentElement.classList.toggle("text-zoom", turnedOn);

      const btn = document.getElementById("zoomBtn");
      if (btn) btn.textContent = turnedOn ? "é‚„åŸå­—é«”" : "æ”¾å¤§å­—é«”";
    }

    function logout() {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("token");
      location.reload();
    }
  </script>
</body>

</html>